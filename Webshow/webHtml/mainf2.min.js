function TaskClass(e, a) { this._state = e, this._carSelect = a, this._oldState = e, this._newState = e } TaskClass.prototype.__defineGetter__("state", function () { return this._state }), TaskClass.prototype.__defineSetter__("state", function (e) { this._state = e, this._oldState != this._state && (operatePanel.refresh(), this._oldState = e) }), TaskClass.prototype.__defineGetter__("carSelect", function () { return this._carSelect }), TaskClass.prototype.__defineSetter__("carSelect", function (e) { this._carSelect = e }); var objMain = { debug: "www.nyrq123.com" == window.location.hostname ? 2 : "192.168.0.112" == window.location.hostname ? 1 : 0, indexKey: "", displayName: "", positionInStation: 0, MoneyForSave: 0, Money: 0, state: "", receivedState: "", scene: null, renderer: null, labelRenderer: null, centerPosition: { lon: 112.573463, lat: 37.891474 }, roadGroup: null, basePoint: null, fpIndex: -1, othersBasePoint: {}, playerGroup: null, carGroup: null, collectGroup: null, getOutGroup: null, robotModel: null, buildingModel: {}, buildingGroup: null, fightSituationGroup: null, cars: {}, rmbModel: {}, ModelInput: { speed: null, attack: null, shield: null, confusePrepare: null, lostPrepare: null, ambushPrepare: null, water: null, direction: null, directionArrow: null, Opponent: null, Teammate: null }, shieldGroup: null, confusePrepareGroup: null, lostPrepareGroup: null, ambushPrepareGroup: null, waterGroup: null, waterMarkGroup: null, fireGroup: null, fireMarkGroup: null, lightningGroup: null, lightningMarkGroup: null, absorbGroup: null, directionGroup: null, targetGroup: null, clock: null, leaveGameModel: null, profileModel: null, light1: null, controls: null, raycaster: null, mouse: null, raycasterOfSelector: null, selectorPosition: { x: 0, y: .5 }, selectObj: { obj: null, type: "" }, canSelect: !1, carsNames: null, carsAnimateData: {}, PromoteState: -1, PromotePositions: { mile: null, business: null, volume: null, speed: null }, PromoteList: ["mile", "business", "volume", "speed"], PromoteDiamondCount: { mile: 0, business: 0, volume: 0, speed: 0 }, CollectPosition: {}, diamondGeometry: null, mirrorCubeCamera: null, promoteDiamond: null, columnGroup: null, mainF: { drawLineOfFpToRoad: function (e, a, t, n) { var o = new THREE.Vector3(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), i = new THREE.Vector3(MercatorGetXbyLongitude(e.positionLongitudeOnRoad), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.positionLatitudeOnRoad)), e = new THREE.Geometry; e.vertices.push(o), e.vertices.push(i); t = new THREE.LineBasicMaterial({ color: t }), t = new THREE.Line(e, t); t.name = "approach_" + n, a.add(t) }, lookAtPosition: function (e) { var a = new THREE.Vector3(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), t = new THREE.Vector3(MercatorGetXbyLongitude(e.positionLongitudeOnRoad), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.positionLatitudeOnRoad)), n = new Complex(t.x - a.x, t.z - a.z); n.toOne(); var o = 5 * objMain.controls.minDistance, t = objMain.controls.maxPolarAngle - Math.PI / 30, t = new THREE.Vector3(a.x + n.r * o * Math.sin(t), a.y + o * Math.abs(Math.cos(t)), a.z + n.i * o * Math.sin(t)); objMain.camera.position.set(t.x, t.y, t.z), objMain.controls.target.set(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), objMain.camera.lookAt(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), objMain.renderer.render(objMain.scene, objMain.camera), objMain.labelRenderer.render(objMain.scene, objMain.camera) }, lookAtPosition2: function () { var e = new Complex(1, 0); e.toOne(); var a = 1.1 * objMain.controls.minDistance, t = objMain.controls.maxPolarAngle - Math.PI / 30, n = objMain.transtractionData, t = new THREE.Vector3(n.x + e.r * a * Math.sin(t), n.y + a * Math.cos(t), n.z + e.i * a * Math.sin(t)); objMain.camera.position.set(t.x, t.y, t.z), objMain.controls.target.set(n.x, 0, n.z), objMain.camera.lookAt(n.x, 0, n.z) }, initilizeCars: function (e, a, t, n, o) { null == n && (n = !0); var i = new THREE.Vector3(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), r = new Complex((b = new THREE.Vector3(MercatorGetXbyLongitude(e.positionLongitudeOnRoad), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.positionLatitudeOnRoad))).x - i.x, b.z - i.z); r.toOne(); var s = r.multiply(new Complex(-.309016994, .951056516)), l = s.multiply(new Complex(.809016994, .587785252)), c = l.multiply(new Complex(.809016994, .587785252)), d = c.multiply(new Complex(.809016994, .587785252)), r = d.multiply(new Complex(.809016994, .587785252)), r = [s, l, c, d, r], o = o, i = new THREE.Vector3(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), b = new THREE.Vector3(i.x + .25 * r[o].r, MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, i.z + .25 * r[o].i), e = new THREE.Geometry; e.vertices.push(i), e.vertices.push(b); a = new THREE.LineBasicMaterial({ color: a }), a = new THREE.Line(e, a); a.name = "carRoad_" + t, t === objMain.indexKey && (n = !0), a.userData = { objectType: "carRoad", parent: t }, objMain.carGroup.add(a); a = null; (a = (n ? objMain.cars[["carA", "carB", "carC", "carD", "carE"][o]] : objMain.cars.carO).clone()).name = "car_" + t, a.position.set(b.x, b.y, b.z), a.scale.set(.002, .002, .002), a.rotateY(-r[o].toAngle()), a.userData = { objectType: "car", parent: t }, objMain.carGroup.add(a) }, lookTwoPositionCenter: function (e, a) { var t, n, o = e, e = a, a = objMain.mainF.getLength(o, e); .2 < a && ((t = new Complex(e.x - o.x, e.z - o.z)).toOne(), n = (a / (1 / Math.tan(Math.PI / 6) - 1 / Math.tan(42 * Math.PI / 180)) / Math.tan(42 * Math.PI / 180) + a / 2) / Math.cos(36 * Math.PI / 180)); a = 54 * Math.PI / 180, a = new THREE.Vector3(o.x + t.r * n * Math.sin(a), o.y + n * Math.cos(a), o.z + t.i * n * Math.sin(a)); objMain.camera.position.set(a.x, a.y, a.z), objMain.controls.target.set((o.x + e.x) / 2, 0, (o.z + e.z) / 2), objMain.camera.lookAt((o.x + e.x) / 2, 0, (o.z + e.z) / 2) }, getLength: function (e, a) { return Math.sqrt((e.x - a.x) * (e.x - a.x) + (e.y - a.y) * (e.y - a.y) + (e.z - a.z) * (e.z - a.z)) }, removeF: { removePanle: function (e) { for (; null != document.getElementById(e);)document.getElementById(e).remove() }, clearGroup: function (e) { for (var a = e.children.length - 1; 0 <= a; a--)e.remove(e.children[a]) } }, refreshPromotionDiamondAndPanle: function (e) { if ("OnLine" == objMain.state || "LookForBuildings" == objMain.state) { var a = "diamond_" + e.resultType; null != objMain.promoteDiamond.getObjectByName(a) && objMain.promoteDiamond.remove(objMain.promoteDiamond.getObjectByName(a)); a = "approach_diamond_" + e.resultType; null != objMain.promoteDiamond.getObjectByName(a) && objMain.promoteDiamond.remove(objMain.promoteDiamond.getObjectByName(a)); var t = 0, n = null; switch (e.resultType) { case "mile": n = DiamondModel.red, t = 16711680; break; case "business": n = DiamondModel.green, t = 65280; break; case "volume": n = DiamondModel.blue, t = 255; break; case "speed": n = DiamondModel.black, t = 0 }if (null == n) return; a = n.children[0].clone(); a.userData.Fp = objMain.PromotePositions[e.resultType].Fp, a.name = "diamond_" + e.resultType, a.scale.set(.2, .22, .2), a.position.set(MercatorGetXbyLongitude(objMain.PromotePositions[e.resultType].Fp.Longitude), MercatorGetZbyHeight(objMain.PromotePositions[e.resultType].Fp.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(objMain.PromotePositions[e.resultType].Fp.Latitde)), objMain.promoteDiamond.add(a), objMain.mainF.drawLineOfFpToRoad(objMain.PromotePositions[e.resultType].Fp, objMain.promoteDiamond, t, "diamond_" + e.resultType) } }, refreshCollectAndPanle: function (e, a) { if ("OnLine" == objMain.state) { var t = "moneymodel" + e, n = objMain.collectGroup.getObjectByName(t); null == n || (null == a && null != n.userData.endF && (a = n.userData.endF), objMain.collectGroup.remove(n)); n = "approach_money" + e, n = objMain.collectGroup.getObjectByName(n); null == n || objMain.collectGroup.remove(n); var o; switch (function (e) { switch (e) { case 0: return 100; case 1: case 2: return 50; case 3: case 4: case 5: case 6: case 7: return 20; case 8: case 9: case 10: case 11: case 12: case 13: case 14: case 15: case 16: case 17: return 10; case 18: case 19: case 20: case 21: case 22: case 23: case 24: case 25: case 26: case 27: case 28: case 29: case 30: case 31: case 32: case 33: case 34: case 35: case 36: case 37: return 5; default: return 0 } }(e)) { case 5: o = objMain.rmbModel.rmb5.clone(); break; case 10: o = objMain.rmbModel.rmb10.clone(); break; case 20: o = objMain.rmbModel.rmb20.clone(); break; case 50: o = objMain.rmbModel.rmb50.clone(); break; case 100: o = objMain.rmbModel.rmb100.clone(); break; default: return }null != objMain.CollectPosition[e] && (o.position.set(MercatorGetXbyLongitude(objMain.CollectPosition[e].Fp.Longitude), MercatorGetZbyHeight(objMain.CollectPosition[e].Fp.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(objMain.CollectPosition[e].Fp.Latitde)), o.name = t, o.userData.collectPosition = objMain.CollectPosition[e], objMain.collectGroup.add(o), objMain.mainF.drawLineOfFpToRoad(objMain.CollectPosition[e].Fp, objMain.collectGroup, 16766720, "money" + e), "collect" == objMain.Task.state && objMain.mainF.drawPanelOfCollect(a)) } }, drawPanelOfCollect: function (e) { for (var a = objMain.groupOfOperatePanle.children.length - 1; 0 <= a; a--)objMain.groupOfOperatePanle.remove(objMain.groupOfOperatePanle.children[a]); for (var t, n, o, a = 0; a < 38; a++)null != objMain.CollectPosition[a] && ((o = document.createElement("div")).style.width = "10em", o.style.marginTop = "3em", o.style.border = "2px solid #ff0000", o.style.borderTopLeftRadius = "0.5em", o.style.backgroundColor = "rgba(155, 55, 255, 0.3)", o.style.color = "#1504f6", (n = document.createElement("div")).style.fontSize = "0.5em", (t = document.createElement("b")).innerHTML = '到[<span style="color:#f5ffba">' + objMain.CollectPosition[a].Fp.FastenPositionName + '</span>]回收<span style="color:#f5ffba">' + objMain.CollectPosition[a].collectMoney.toFixed(2) + "元</span>现金。", n.appendChild(t), o.appendChild(n), n = new THREE.CSS2DObject(o), o = objMain.CollectPosition[a].Fp, n.position.set(MercatorGetXbyLongitude(o.Longitude), 0, -MercatorGetYbyLatitude(o.Latitde)), objMain.groupOfOperatePanle.add(n)) }, removeRole: function (e) { var a = "carRoad_" + e; objMain.carGroup.remove(objMain.carGroup.getObjectByName(a)); a = "car_" + e; stateSet.speed.clear(a), stateSet.attck.clear(a), stateSet.confuse.clear(a), stateSet.lost.clear(a), objMain.carGroup.remove(objMain.carGroup.getObjectByName(a)); a = "approach_" + e; objMain.playerGroup.remove(objMain.playerGroup.getObjectByName(a)); a = "flag_" + e; objMain.playerGroup.remove(objMain.playerGroup.getObjectByName(a)), stateSet.lightning.clear(e), stateSet.water.clear(e), stateSet.fire.clear(e), stateSet.defend.clear(e), delete objMain.othersBasePoint[e] }, drawDiamondCollected: function () { var e = objMain.basePoint, a = (objMain.indexKey, new THREE.Vector3(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde))), t = new Complex((p = new THREE.Vector3(MercatorGetXbyLongitude(e.positionLongitudeOnRoad), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.positionLatitudeOnRoad))).x - a.x, p.z - a.z); t.toOne(); for (var n = t.multiply(new Complex(0, 1)), o = n.multiply(new Complex(.5, .86602)), i = o.multiply(new Complex(.5, .86602)), t = i.multiply(new Complex(.5, .86602)), r = [n, o, i, t], s = ["BatteryMile", "BatteryBusiness", "BatteryVolume", "BatterySpeed"], l = ["mile", "business", "volume", "speed"], c = [16711680, 65280, 255, 0], d = 0; d < r.length; d++) { var b, u, a = new THREE.Vector3(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), p = new THREE.Vector3(a.x + .5 * r[d].r, MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, a.z + .5 * r[d].i); null == objMain.columnGroup.getObjectByName(s[d]) ? (b = new THREE.CylinderGeometry(.05, .05, .05, 16), u = c[d], u = new THREE.MeshPhongMaterial({ color: u, transparent: !0, opacity: .6 }), (b = new THREE.Mesh(b, u)).castShadow = !0, b.receiveShadow = !0, b.name = s[d], b.scale.setY(.01), b.position.set(p.x, p.y, p.z), b.userData.index = l[d], objMain.columnGroup.add(b)) : b = objMain.columnGroup.getObjectByName(s[d]), null != objMain.PromoteDiamondCount[l[d]] && (u = objMain.PromoteDiamondCount[l[d]], u = Math.max(.01, u), b.scale.setY(u)) } }, updateCollectGroup: function () { }, refreshBuyPanel: function () { objMain.mainF.removeF.clearGroup(objMain.groupOfOperatePanle); var e = document.createElement("div"); e.style.width = "10em", e.style.marginTop = "3em"; e.style.border = "2px solid #ff0000", e.style.borderTopLeftRadius = "0.5em", e.style.backgroundColor = "rgba(255, 255, 255, 0.5)", e.style.color = "#1504f6"; var a = document.createElement("div"), t = document.createElement("b"); t.innerHTML = "现在售价如下红宝石10.00，蓝宝石10.00，蓝宝石10.00，黑宝石10.00！点击柱状仓库，进行购买！", a.appendChild(t), e.appendChild(a); a = new THREE.CSS2DObject(e), e = objMain.basePoint; a.position.set(MercatorGetXbyLongitude(e.Longitude), MercatorGetZbyHeight(e.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(e.Latitde)), objMain.groupOfOperatePanle.add(a) } }, Task: new TaskClass("", ""), animation: { animateCameraByCarAndTask: function () { "mile" == objMain.Task.state && "" != objMain.Task.carSelect && (objMain.promoteDiamond.children[0].position, objMain.carGroup.getObjectByName(objMain.Task.carSelect).position) } }, groupOfOperatePanle: null, groupOfTaskCopy: null, GetPositionNotify: { data: null, F: function (e) { console.log(e); e = JSON.parse(e); objMain.basePoint = e.fp, objMain.carsNames = e.carsNames, objMain.indexKey = e.key, objMain.displayName = e.PlayerName, objMain.fpIndex = e.fPIndex, objMain.positionInStation = e.positionInStation, drawPoint("green", objMain.basePoint, objMain.indexKey), objMain.mainF.drawLineOfFpToRoad(objMain.basePoint, objMain.playerGroup, "green", objMain.indexKey), objMain.mainF.drawDiamondCollected(), objMain.mainF.lookAtPosition(objMain.basePoint), objMain.mainF.initilizeCars(objMain.basePoint, "green", objMain.indexKey, !0, objMain.positionInStation), objMain.GetPositionNotify.data = null, SysOperatePanel.draw(), frequencyShow.show(), operateStateShow.show() } }, Tax: {}, taxGroup: null, buildingSelectionGroup: null, msg: {}, panOrRotate: "rotate", carState: { stamp: -1 }, carStateTimestamp: {}, music: { theme: "", change: function () { var e = document.getElementById("backGroudMusick"); if (0 === e.currentTime || e.ended) if ("" === this.theme) { for (var a = e.children.length - 1; 0 <= a; a--)e.children[a].remove(); (t = document.createElement("source")).src = "bgm/changshoucunwai.ogg", t.type = "audio/ogg", (n = document.createElement("source")).src = "bgm/changshoucunwai.mp3", n.type = "audio/mpeg", e.appendChild(t), e.appendChild(n), e.load(), this.on && e.play() } else { for (var t, n, a = e.children.length - 1; 0 <= a; a--)e.children[a].remove(); (t = document.createElement("source")).src = "bgm/" + this.theme + ".ogg", t.type = "audio/ogg", (n = document.createElement("source")).src = "bgm/" + this.theme + ".mp3", n.type = "audio/mpeg", e.appendChild(t), e.appendChild(n), e.load(), this.on && e.play() } }, on: !0 }, background: { path: "", change: function () { var e; e = ("" === this.path ? (e = new THREE.CubeTextureLoader).setPath("Pic/") : (e = new THREE.CubeTextureLoader).setPath("Pic/" + this.path + "/"), e.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"])), objMain.background.backgroundData.main = e, objMain.scene.background = objMain.background.backgroundData.main }, backgroundData: {}, changeWhenIsCross: function (e) { var a; e.IsDetalt ? objMain.scene.background = objMain.background.backgroundData.main : (null == objMain.background.backgroundData[e.Md5Key] && (a = (2 != objMain.debug ? (a = new THREE.CubeTextureLoader).setPath("http://127.0.0.1:11001/bgimg/" + e.Md5Key + "/") : (a = new THREE.CubeTextureLoader).setPath("https://www.nyrq123.com/imgtaiyuan/" + e.Md5Key + "/"), a.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"])), objMain.background.backgroundData[e.Md5Key] = a), objMain.scene.background = objMain.background.backgroundData[e.Md5Key]) } }, rightAndDuty: { data: {}, update: function () { } }, dealWithReceivedObj: function (e, a, t) { switch (e.c) { case "setState": switch (objMain.receivedState = e.state, objMain.receivedState) { case "selectSingleTeamJoin": selectSingleTeamJoinHtml(); break; case "OnLine": if ("LookForBuildings" === objMain.state) objMain.state = objMain.receivedState, setTransactionHtml.cancle(), setTransactionHtml.change(); else { for (var n in set3DHtml(), objMain.ws.send("SetOnLine"), objMain.othersBasePoint) { var o = n, i = objMain.othersBasePoint[n].basePoint; drawPoint("orange", i, o), objMain.mainF.drawLineOfFpToRoad(i, objMain.playerGroup, "green", o), objMain.mainF.initilizeCars(i, "orange", o, !1, objMain.othersBasePoint[n].positionInStation), console.log("哦哦", "出现了预料的情况！！！") } objMain.state = objMain.receivedState } objMain.state = objMain.receivedState; window.onbeforeunload = function () { if (!confirm("确认离开www.nyrq123.com?")) return !1 }; break; case "WaitingToStart": setWaitingToStart(); break; case "WaitingToGetTeam": setWaitingToGetTeam(); break; case "LookForBuildings": "OnLine" == objMain.state && (objMain.state = objMain.receivedState, setTransactionHtml.change(), operatePanel.refresh()); break; case "QueryReward": objMain.state = objMain.receivedState, objMain.ws.send(JSON.stringify({ c: "RewardInfomation", Page: 0 })); break; case "Guid": objMain.state = objMain.receivedState, GuidObj.gameIntroShow(); break; case "empty": var r; "OnLine" == objMain.state && (objMain.state = "", objMain.receivedState = "", r = document.getElementById("rootContainer").innerHTML = "", null == sessionStorage.session || (r = sessionStorage.session), objMain.ws.send(JSON.stringify({ c: "CheckSession", session: r })), driverSys.clearIcon(), SysOperatePanel.remove(), carAbility.clear(), frequencyShow.clear(), moneyShow.clear(), operateStateShow.clear(), objMain.stateNeedToChange.isLogin = !1, objMain.stateNeedToChange.HasNewTask = !1, operatePanel.clearPanel(), subsidizeSys.clearInfo(), dialogSys.clear(), objMain.othersBasePoint = {}, MapData.initialize()) }break; case "setSession": sessionStorage.session = e.session; break; case "TeamCreateFinish": console.log("提示", "队伍创建成功"), "WaitingToStart" == objMain.receivedState && (token.CommandStart = e.CommandStart, createTeam(e)); break; case "TeamJoinFinish": console.log("提示", "加入队伍成功"), "WaitingToGetTeam" == objMain.receivedState && joinTeamDetail(e); break; case "Alert": alert(e.msg); break; case "TeamJoinBroadInfo": "WaitingToGetTeam" != objMain.receivedState && "WaitingToStart" != objMain.receivedState || broadTeamJoin(e); break; case "TeamJoinRemoveInfo": "WaitingToGetTeam" != objMain.receivedState && "WaitingToStart" != objMain.receivedState || broadTeamMemberRemove(e); break; case "TeamNumWithSecret": "WaitingToGetTeam" == objMain.receivedState && (console.log("secret", t), b = { Secret: e.Secret, WebSocketID: e.WebSocketID, c: "TeamNumWithSecret", RefererAddr: nyrqUrl.get() }, objMain.ws.send(JSON.stringify(b))); break; case "GetOthersPositionNotify_v2": console.log(a.data); var s, l, c, d, b, u = JSON.parse(a.data); u.key == objMain.indexKey || (i = u.fp, o = u.key, s = u.PlayerName, l = u.fPIndex, c = u.positionInStation, d = u.isNPC, b = u.isPlayer, u = u.Level, objMain.othersBasePoint[o] = { basePoint: i, indexKey: o, playerName: s, fPIndex: l, isNPC: d, isPlayer: b, Level: u }, "OnLine" == objMain.state && (drawPoint("orange", i, o), objMain.mainF.drawLineOfFpToRoad(i, objMain.playerGroup, "green", o), objMain.mainF.initilizeCars(i, "orange", o, !1, c))); break; case "GetPositionNotify_v2": if ("OnLine" != objMain.state) { p = "GetPositionNotify出入时，状态为" + objMain.state; throw console.log("提示", p), p } var p = "先执行了 OnLine命令"; console.log("提示", p), objMain.GetPositionNotify.F(a.data); break; case "MapRoadAndCrossJson": switch (e.action) { case "start": Map.roadAndCrossJson = "", objMain.ws.send("MapRoadAndCrossJson,start"); break; case "mid": Map.roadAndCrossJson += e.passStr, objMain.ws.send("MapRoadAndCrossJson,mid"); break; case "end": Map.roadAndCross = JSON.parse(Map.roadAndCrossJson), Map.roadAndCrossJson = "", objMain.ws.send("MapRoadAndCrossJson,end") }break; case "SetRobot": (M = function (a, e, n) { var t = new THREE.LoadingManager; new THREE.MTLLoader(t).loadTextOnly(a.modelBase64[1], "data:image/png;base64," + a.modelBase64[e], function (e) { e.preload(), new THREE.OBJLoader(t).setMaterials(e).loadTextOnly(a.modelBase64[0], function (e) { console.log("o", e); for (var a = 0; a < e.children.length; a++)if (e.children[a].isMesh) for (var t = 0; t < e.children[a].material.length; t++)e.children[a].material[t].transparent = !0, e.children[a].material[t].opacity = 1, e.children[a].material[t].side = THREE.FrontSide; objMain.cars[n] = e }, function () { }, function () { }) }) })(e, 2, "carA"), M(e, 3, "carB"), M(e, 4, "carC"), M(e, 5, "carD"), M(e, 6, "carE"), M(e, 7, "carO"), M(e, 8, "carO2"), objMain.ws.send("SetRobot"); break; case "SetRMB": var M = function (e, n) { var a = new THREE.LoadingManager; new THREE.MTLLoader(a).loadTextOnly(e.modelBase64[0], "data:image/jpeg;base64," + e.modelBase64[1], function (e) { e.preload(), new THREE.OBJLoader(a).setMaterials(e).loadTextOnly(objMain.rmbModel.geometry, function (e) { console.log("o", e); for (var a = 0; a < e.children.length; a++)if (e.children[a].isMesh) for (var t = 0; t < e.children[a].material.length; t++)e.children[a].material[t].transparent = !0, e.children[a].material[t].opacity = 1, e.children[a].material[t].side = THREE.FrontSide, e.children[a].material[t].color = new THREE.Color(.45, .45, .45); console.log("o", e), e.scale.set(.003, .003, .003), e.rotateX(-Math.PI / 2), objMain.rmbModel[n] = e }, function () { }, function () { }) }) }; switch (e.faceValue) { case "model": objMain.rmbModel.geometry = e.modelBase64, objMain.ws.send("SetRMB"); break; case "rmb100": case "rmb50": case "rmb20": case "rmb10": case "rmb5": M(e, e.faceValue), objMain.ws.send("SetRMB"); break; case "rmb1": M(e, e.faceValue), objMain.rmbModel.geometry = void 0, objMain.ws.send("SetRMB") }break; case "SetSpeedIcon": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.speed = e }, transparent: { opacity: .7 }, color: { r: 2, g: 1, b: 2 } }), objMain.ws.send("SetSpeedIcon"); break; case "SetAttackIcon": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.attack = e }, transparent: { opacity: .5 }, color: { r: 2, g: 2, b: .4 } }), objMain.ws.send("SetAttackIcon"); break; case "SetShield": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.shield = e }, transparent: { opacity: .8 }, color: { r: 2, g: 1, b: 1 } }), objMain.ws.send("SetShield"); break; case "SetConfusePrepareIcon": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.confusePrepare = e }, transparent: { opacity: .8 }, color: { r: 1.5, g: 1.5, b: 1.5 } }), objMain.ws.send("SetConfusePrepareIcon"); break; case "SetLostPrepareIcon": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.lostPrepare = e }, transparent: { opacity: 1 }, color: { r: 1, g: 1.2, b: 1.2 } }), objMain.ws.send("SetLostPrepareIcon"); break; case "SetAmbushPrepareIcon": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.ambushPrepare = e }, transparent: { opacity: 1 }, color: { r: 1.3, g: .9, b: .9 } }), objMain.ws.send("SetAmbushPrepareIcon"); break; case "SetWaterIcon": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.water = e } }), objMain.ws.send("SetWaterIcon"); break; case "SetDirectionIcon": ModelOperateF.f(e, { bind: function (e) { objMain.ModelInput.direction = e }, transparent: { opacity: .3 } }), objMain.ws.send("SetDirectionIcon"); break; case "SetDirectionArrowIcon": ModelOperateF.f(e, { bind: function (e) { var a = e.children[0].material, t = e.children[0].material.clone(); t.transparent = !1, t.color = new THREE.Color(1, 2, 1), objMain.ModelInput.directionArrow = { obj: e, oldM: a, newM: t } }, transparent: { opacity: .3 } }), objMain.ws.send("SetDirectionArrowIcon"); break; case "SetOpponentIcon": ModelOperateF.f(e, { bind: function (e) { e.children[0].material; var a = e.children[0].material.clone(); a.transparent = !1, a.color = new THREE.Color(1.2, 1.2, 1.2), objMain.ModelInput.Opponent = { obj: e } }, transparent: { opacity: .8 }, scale: { x: 1, y: 1, z: 1 }, rotateX: Math.PI }), objMain.ws.send("SetOpponentIcon"); break; case "SetTeammateIcon": ModelOperateF.f(e, { bind: function (e) { e.children[0].material; var a = e.children[0].material.clone(); a.transparent = !1, a.color = new THREE.Color(1.2, 1.2, 1.2), objMain.ModelInput.Teammate = { obj: e } }, transparent: { opacity: .8 }, scale: { x: 1, y: 1, z: 1 }, rotateX: Math.PI }), objMain.ws.send("SetTeammateIcon"); break; case "BradCastAnimateOfOthersCar3": (m = JSON.parse(a.data)).passPrivateKeysOnly = !1, carAnimationData(m); break; case "BradCastAnimateOfOthersCar4": (m = JSON.parse(a.data)).passPrivateKeysOnly = !0, carAnimationData(m); break; case "BradCastPromoteInfoDetail": console.log("显示", e), objMain.PromotePositions[e.resultType] = e, objMain.mainF.refreshPromotionDiamondAndPanle(e); break; case "BradCastCollectInfoDetail": objMain.CollectPosition = e; break; case "SetDiamond": DiamondModel.initialize(e); var m = new THREE.LoadingManager; new THREE.OBJLoader(m).loadTextOnly(e.objText, function (e) { console.log("SetDiamond", e.children[0].geometry); e = e.children[0].geometry; objMain.diamondGeometry = e }, function () { }, function () { }), objMain.ws.send("SetDiamond"); break; case "DialogMsg": dialogSys.dealWithMsg(e); break; case "BradCastMoneyForSave": objMain.MoneyForSave = e.Money; break; case "BradCastPromoteDiamondCount": objMain.PromoteDiamondCount[e.pType] = e.count, objMain.mainF.drawDiamondCollected(); break; case "BradCastAbility": carAbility.drawPanel("car"), carAbility.setData(e), carAbility.drawChanel(e.carIndexStr), carAbility.refreshPosition(); break; case "MoneyForSaveNotify": moneyOperator.MoneyForSave = e.MoneyForSave, moneyOperator.updateMoneyForSave(); break; case "LeftMoneyInDB": subsidizeSys.LeftMoneyInDB[e.address] = e.Money, nyrqUrl.set(e.address), subsidizeSys.updateMoneyOfSumSubsidizing(); break; case "SupportNotify": subsidizeSys.SupportMoney = e.Money, subsidizeSys.updateMoneyOfSumSubsidized(); break; case "TheLargestHolderChangedNotify": theLagestHoderKey.data[e.operateKey] = e, objMain.mainF.updateCollectGroup(); break; case "OthersRemove": objMain.mainF.removeRole(e.othersKey), theLagestHoderKey.removeData(e.othersKey), delete SocialResponsibility.data[e.othersKey], delete objMain.rightAndDuty.data[e.othersKey]; break; case "SingleRoadPathData": for (var i = e.basePoint, j = 0; j < e.meshPoints.length; j += 12) { var h = [(e.meshPoints[j + 0] + i[0]) / 1e6, (e.meshPoints[j + 1] + i[1]) / 1e6, (e.meshPoints[j + 2] + i[2]) / 1e6, (e.meshPoints[j + 3] + i[0]) / 1e6, (e.meshPoints[j + 4] + i[1]) / 1e6, (e.meshPoints[j + 5] + i[2]) / 1e6, (e.meshPoints[j + 6] + i[0]) / 1e6, (e.meshPoints[j + 7] + i[1]) / 1e6, (e.meshPoints[j + 8] + i[2]) / 1e6, (e.meshPoints[j + 9] + i[0]) / 1e6, (e.meshPoints[j + 10] + i[1]) / 1e6, (e.meshPoints[j + 11] + i[2]) / 1e6]; MapData.meshPoints.push(h) } !function () { objMain.mainF.removeF.clearGroup(objMain.roadGroup); for (var e = MapData.meshPoints, a = [], t = 0; t < e.length; t++)a.push(MercatorGetXbyLongitude(e[t][0]), MercatorGetXbyLongitude(e[t][2]) * objMain.heightAmplify, -MercatorGetYbyLatitude(e[t][1]), MercatorGetXbyLongitude(e[t][3]), MercatorGetXbyLongitude(e[t][5]) * objMain.heightAmplify, -MercatorGetYbyLatitude(e[t][4]), MercatorGetXbyLongitude(e[t][6]), MercatorGetXbyLongitude(e[t][8]) * objMain.heightAmplify, -MercatorGetYbyLatitude(e[t][7]), MercatorGetXbyLongitude(e[t][6]), MercatorGetXbyLongitude(e[t][8]) * objMain.heightAmplify, -MercatorGetYbyLatitude(e[t][7]), MercatorGetXbyLongitude(e[t][9]), MercatorGetXbyLongitude(e[t][11]) * objMain.heightAmplify, -MercatorGetYbyLatitude(e[t][10]), MercatorGetXbyLongitude(e[t][0]), MercatorGetXbyLongitude(e[t][2]) * objMain.heightAmplify, -MercatorGetYbyLatitude(e[t][1])); var n = new THREE.BufferGeometry; n.addAttribute("position", new THREE.Float32BufferAttribute(a, 3).onUpload(function () { this.array = null })), n.computeBoundingSphere(); var o = new THREE.MeshBasicMaterial({ color: 16711833 }), o = new THREE.Mesh(n, o); objMain.roadGroup.add(o), n = new THREE.EdgesGeometry(n), n = new THREE.LineSegments(n, new THREE.LineBasicMaterial({ color: 255 })), objMain.roadGroup.add(n) }(); break; case "SetLeaveGameIcon": objMain.ws.send("SetLeaveGameIcon"); for (var g = e.data[0], y = e.data[1], f = {}, j = 2; j < e.data.length; j += 2) { var w = e.data[j], E = e.data[j + 1]; f[w] = "data:image/jpeg;base64," + E } console.log("imageBase64s", f), (M = function (a, e, t) { var n = new THREE.LoadingManager; new THREE.MTLLoader(n).loadTextWithMulImg(e, t, function (e) { e.preload(), new THREE.OBJLoader(n).setMaterials(e).loadTextOnly(a, function (e) { console.log("o", e), console.log("o", e), e.scale.set(.003, .003, .003), e.rotateX(-Math.PI / 2), objMain.leaveGameModel = e }, function () { }, function () { }) }) })(g, y, f); break; case "SetProfileIcon": objMain.ws.send("ProfileIcon"); for (g = e.data[0], y = e.data[1], f = {}, j = 2; j < e.data.length; j += 2) { w = e.data[j], E = e.data[j + 1]; f[w] = "data:image/jpeg;base64," + E } console.log("imageBase64s", f), (M = function (a, e, t) { var n = new THREE.LoadingManager; new THREE.MTLLoader(n).loadTextWithMulImg(e, t, function (e) { e.preload(), new THREE.OBJLoader(n).setMaterials(e).loadTextOnly(a, function (e) { console.log("o", e), console.log("o", e), e.scale.set(.003, .003, .003), e.rotateX(-Math.PI / 2), objMain.profileModel = e }, function () { }, function () { }) }) })(g, y, f); break; case "MoneyNotify": objMain.Money = e.Money, moneyShow.show(); break; case "BradCastSocialResponsibility": SocialResponsibility.data[e.otherKey] = e.socialResponsibility, objMain.indexKey == e.otherKey && SocialResponsibility.show(); break; case "GetName": null != document.getElementById("playerNameTextArea") && (document.getElementById("playerNameTextArea").value = e.name); break; case "GetCarsName": for (j = 0; j < 5; j++) { var P = "car" + (j + 1) + "NameTextArea"; null != document.getElementById(P) && (document.getElementById(P).value = e.names[j]) } break; case "BradCarState": e.countStamp > objMain.carState.stamp && (objMain.carState.stamp = e.countStamp, objMain.carState[e.carID] = e.State, y = objMain.mainF.getLength(objMain.camera.position, objMain.controls.target), objMain.carStateTimestamp[e.carID] = { t: Date.now(), l: y }, objNotify.notifyCar(e.carID, e.State), operatePanel.refresh(), y = { c: "CheckCarState", State: objMain.carState[e.carID], Key: "Key" }, objMain.ws.send(JSON.stringify({ checkObj: y }))); break; case "BradCastCollectInfoDetail_v2": console.log("显示", e), objMain.CollectPosition[e.collectIndex] = e, objMain.mainF.refreshCollectAndPanle(e.collectIndex, void 0); break; case "BradCarPurpose": console.log("显示", "BradCarPurpose"); break; case "BradCastRightAndDuty": objMain.rightAndDuty.data[e.playerKey] = { right: e.right, duty: e.duty, rightPercent: e.rightPercent, dutyPercent: e.dutyPercent }; break; case "BradCastMusicTheme": objMain.music.theme = e.theme; break; case "BradCastBackground": objMain.background.path = e.path, objMain.background.change(); break; case "WMsg": $.notify(e.Msg, { style: "happyblue" }); break; case "BradDiamondPrice": objMain.diamondPrice[e.priceType] = e.price; break; case "DriverNotify": objMain.driver.driverIndex = e.index, objMain.driver.name = e.name, objMain.driver.skill1.name = e.skill1Name, objMain.driver.skill1.skillIndex = e.skill1Index, objMain.driver.skill2.name = e.skill2Name, objMain.driver.skill2.skillIndex = e.skill2Index, objMain.driver.sex = e.sex, objMain.driver.race = e.race, driverSys.drawIcon(objMain.driver), operatePanel.refresh(); break; case "SpeedNotify": e.On ? stateSet.speed.add(e.Key) : stateSet.speed.clear(e.Key); break; case "AttackNotify": e.On ? stateSet.attck.add(e.Key) : stateSet.attck.clear(e.Key); break; case "DefenceNotify": e.On ? stateSet.defend.add(e.Key) : stateSet.defend.clear(e.Key); break; case "ViewSearch": var S = { old: { x: objMain.controls.target.x, y: objMain.controls.target.y, z: objMain.controls.target.z, t: Date.now() }, newT: { x: e.mctX, y: objMain.controls.target.y, z: 0 - e.mctY, t: Date.now() + 3e3 } }; objMain.camaraAnimateData = S; break; case "ConfusePrepareNotify": e.On && (stateSet.control.clear(e.Key), v = { startX: e.StartX / 256, startY: objMain.controls.target.y, startZ: e.StartY / -256, start: Date.now(), endX: e.EndX / 256, endY: objMain.controls.target.y, endZ: e.EndY / -256 }, stateSet.confusePrepare.add(e.Key, v)); break; case "LostPrepareNotify": e.On && (stateSet.control.clear(e.Key), v = { startX: e.StartX / 256, startY: objMain.controls.target.y, startZ: e.StartY / -256, start: Date.now(), endX: e.EndX / 256, endY: objMain.controls.target.y, endZ: e.EndY / -256 }, stateSet.lostPrepare.add(e.Key, v)); break; case "AmbushPrepareNotify": e.On && (stateSet.control.clear(e.Key), v = { startX: e.StartX / 256, startY: objMain.controls.target.y, startZ: e.StartY / -256, start: Date.now(), endX: e.EndX / 256, endY: objMain.controls.target.y, endZ: e.EndY / -256 }, stateSet.ambusePrepare.add(e.Key, v)); break; case "ControlPrepareNotify": e.On || stateSet.control.clear(e.Key); break; case "LoseNotify": e.On ? stateSet.lost.add(e.Key) : stateSet.lost.clear(e.Key); break; case "ConfuseNotify": e.On ? stateSet.confuse.add(e.Key) : stateSet.confuse.clear(e.Key); break; case "FireNotify": stateSet.fire.add(e.targetRoleID, e.actionRoleID); break; case "WaterNotify": stateSet.water.add(e.targetRoleID, e.actionRoleID); break; case "ElectricNotify": stateSet.lightning.add(e.targetRoleID, e.actionRoleID); break; case "ShowDirectionOperator": DirectionOperator.show(e); break; case "ModelDataShow": var G = e; BuildingModelObj.f(G), QueryReward.lookAt(); break; case "ModelDataShow_Whether_Existed": G = e; BuildingModelObj.respon(G); break; case "ReceiveResult": console.log("ReceiveResult", e); G = e; objMain.transtractionData = { x: e.x, y: e.y, z: e.z }, setTransactionHtml.editRootContainer(), setTransactionHtml.drawAddr(e.bussinessAddress), setTransactionHtml.drawAgreementEditor(), setTransactionHtml.drawStockTable(), setTransactionHtml.drawTradeTable(), setTransactionHtml.originalTable(), transactionBussiness().showAuthor(e.author), operatePanel.refresh(); break; case "TradeDetail": var T = e.addr, O = e.value; e.index; transactionBussiness().addOriginItem(T, O); break; case "TradeDetail2": var S = e.mainAddr, v = e.agreeMent, G = e.sign; transactionBussiness().addTradeItem(S, v, G); break; case "TradeDetail3": e.detail; var T = e.addrStr, O = e.valueStr, k = e.percentValue; transactionBussiness().addStockItem(T, O, k); break; case "ShowAgreement": transactionBussiness().showAgreement(e.agreement); break; case "ShowAgreementMsg": $.notify(e.msg, "error"), GuidObj.charging.showNotifyMsg(e.msg), reward.notifyMsg(e.msg), transactionBussiness().showErrMsg(e.msg); break; case "ShowAllPts": break; case "ClearTradeInfomation": transactionBussiness().ClearItem(), objMain.ws.send("ClearTradeInfomation"); break; case "SetCrossBG": objMain.background.changeWhenIsCross(e); break; case "BustStateNotify": objMain.indexKey == e.KeyBust && SetBustPage(); break; case "GoodsSelectionNotify": drawGoodsSelection.f(e); break; case "ResistanceDisplay": resistance.display(e); break; case "ResistanceDisplay2": resistance.display2(e); break; case "SelectionIsWrong": moneyAbsorb.copyModel(e.reduceValue); break; case "DrawTarget": targetShow.draw(e.x, e.y, e.h * objMain.heightAmplify); break; case "addOption": O = e.id, k = document.createElement("option"); k.value = e.value, k.innerText = e.value, document.getElementById(O).add(k); break; case "ShowRewardAgreement": reward.showAgreement(e.agreement); break; case "GetRewardInfomationHasNotResult": reward.hasNoData(e.title); break; case "GetRewardInfomationHasResult": reward.hasData(e.title, e.data, e.list, e.indexNumber); break; case "VerifyCodePic": localStorage.nyrqVerifyImg = e.base64String, GuidObj.charging.SetImage(e.base64String); break; case "ElectricMarkNotify": stateSet.lightning.mark.add(e.lineParameter); break; case "WaterMarkNotify": stateSet.water.mark.add(e.lineParameter); break; case "FireMarkNotify": stateSet.fire.mark.add(e.lineParameter); break; case "GetFightSituationResult": dialogSys.ShowFightSituation(e); break; case "GetTaskCopyResult": dialogSys.drawPanelOfTaskCoyp(e.Detail); break; case "BradCastPromoteDiamondOnCar": stateSet.diamond.add(e.roleID, e.pType); break; case "SetParameterIsLogin": objMain.stateNeedToChange.isLogin = !0, subsidizeSys.removeBtnsGuid(); break; case "SetParameterHasNewTask": objMain.stateNeedToChange.HasNewTask = !0, dialogSys.AlertNewTask(); break; case "ClearSession": null == sessionStorage.session || (delete sessionStorage.session, objMain.ws.send("ClearSession")); break; default: console.log("命令未注册", e.c + "__没有注册。") } }, diamondPrice: { mile: 0, business: 0, volume: 0, speed: 0 }, driver: { driverIndex: -1, sex: null, name: "", skill1: { name: "", skillIndex: -1 }, skill2: { name: "", skillIndex: -1 }, race: "" }, camaraAnimateData: null, transtractionData: null, trade: { countPerOperate: 1 }, animateObj: null, pingTime: 0, heightAmplify: 5, heightLevel: 0, stateNeedToChange: { isLogin: !1, HasNewTask: !1 } }, startA = function () { var e = ""; switch (objMain.debug) { case 0: switch (prompt("输入选项", "A")) { case "A": e = "ws://127.0.0.1:11001/websocket"; break; case "B": e = "ws://127.0.0.1:11002/websocket"; break; default: e = "ws://127.0.0.1:11001/websocket" }break; case 1: e = "ws://192.168.0.112:11001/websocket"; break; default: e = "wss://www.nyrq123.com/websocket" + window.location.pathname.split("/")[1] + "/" }var a = new WebSocket(e); a.onopen = function () { var e = ""; null == sessionStorage.session || (e = sessionStorage.session), a.send(JSON.stringify({ c: "CheckSession", session: e })) }, a.onmessage = function (e) { var a = e.data, t = JSON.parse(e.data); objMain.dealWithReceivedObj(t, e, a) }, a.onclose = function () { alert("连接已关闭...") }, objMain.ws = a, $.notify.addStyle("happyblue", { html: "<div><span data-notify-text/></div>", classes: { base: { opacity: "0.85", width: "90%", "max-width": "90%", background: "#F5F5F5", padding: "5px", "border- radius": "10px" }, superblue: { opacity: "0.85", width: "90%", "max-width": "90%", background: "#F5F5F5", padding: "5px", "border- radius": "10px" } } }) }; function animate() { switch (objMain.animateObj = requestAnimationFrame(animate), objMain.state != objMain.receivedState && (objMain.state = objMain.receivedState), objMain.state) { case "OnLine": { const k = objMain.mainF.getLength(objMain.camera.position, objMain.controls.target); for (var e = animateDetailF.moveCamara(k), a = 0; a < objMain.collectGroup.children.length; a++)objMain.collectGroup.children[a].isGroup && (n = .006, objMain.collectGroup.children[a].scale.set(n, n, n), objMain.collectGroup.children[a].rotation.set(-Math.PI / 2, 0, Date.now() % 3e3 / 3e3 * Math.PI * 2)); for (a = 0; a < objMain.fightSituationGroup.children.length; a++)objMain.fightSituationGroup.children[a].isGroup && (n = k / 8, objMain.fightSituationGroup.children[a].scale.set(n, n, n), objMain.fightSituationGroup.children[a].rotation.y = Date.now() % 5e3 / 5e3 * Math.PI * 2); for (a = 0; a < objMain.playerGroup.children.length; a++)objMain.playerGroup.children[a].isMesh && (objMain.playerGroup.children[a].scale.set(.0015, .0015, .0015), stateSet.defend.Animate(objMain.playerGroup.children[a].name.split("_")[1]), stateSet.confusePrepare.Animate(objMain.playerGroup.children[a].name.split("_")[1]), stateSet.lostPrepare.Animate(objMain.playerGroup.children[a].name.split("_")[1]), stateSet.ambusePrepare.Animate(objMain.playerGroup.children[a].name.split("_")[1]), stateSet.water.Animate(objMain.playerGroup.children[a].name.split("_")[1]), stateSet.fire.Animate(objMain.playerGroup.children[a].name.split("_")[1]), stateSet.lightning.Animate(objMain.playerGroup.children[a].name.split("_")[1])); stateSet.lightning.mark.Animate(), stateSet.water.mark.Animate(), stateSet.fire.mark.Animate(); for (a = 0; a < objMain.promoteDiamond.children.length; a++)objMain.promoteDiamond.children[a].isMesh && (objMain.promoteDiamond.children[a].scale.set(.2, .22, .2), p = objMain.promoteDiamond.children[a].userData.Fp, objMain.promoteDiamond.children[a].position.set(MercatorGetXbyLongitude(p.Longitude), MercatorGetZbyHeight(p.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(p.Latitde))); for (a = 0; a < objMain.columnGroup.children.length; a++)objMain.columnGroup.children[a].isMesh && (objMain.columnGroup.children[a].scale.setX(1), objMain.columnGroup.children[a].scale.setZ(1)); for (a = 0; a < objMain.buildingGroup.children.length; a++)objMain.buildingGroup.children[a].scale.setX(1), objMain.buildingGroup.children[a].scale.setZ(1); for (a = objMain.groupOfOperatePanle.children.length - 1; 0 <= a; a--)objMain.groupOfOperatePanle.remove(objMain.groupOfOperatePanle.children[a]); if (objMain.canSelect) { var t = "", n = .01; objMain.raycasterOfSelector.setFromCamera(objMain.selectorPosition, objMain.camera); for (var o = null, i = -1, a = 0; a < objMain.collectGroup.children.length; a++)objMain.collectGroup.children[a].isGroup && (r = objMain.collectGroup.children[a].position, s = new THREE.Vector3(r.x - objMain.camera.position.x, r.y - objMain.camera.position.y, r.z - objMain.camera.position.z), .984807753 < (l = objMain.raycasterOfSelector.ray.direction.dot(s) / s.length() / objMain.raycasterOfSelector.ray.direction.length()) && i < l && (i = l, t = "collect", o = objMain.collectGroup.children[a], n = .01 * objMain.mainF.getLength(objMain.camera.position, r) / 10, n = Math.max(n, .01))); for (a = 0; a < objMain.playerGroup.children.length; a++)objMain.playerGroup.children[a].isMesh && (objMain.playerGroup.children[a].name.split("_")[1] == objMain.indexKey ? (r = objMain.playerGroup.children[a].position, s = new THREE.Vector3(r.x - objMain.camera.position.x, r.y - objMain.camera.position.y, r.z - objMain.camera.position.z), .984807753 < (l = objMain.raycasterOfSelector.ray.direction.dot(s) / s.length() / objMain.raycasterOfSelector.ray.direction.length()) && i < l && (i = l, t = "setReturn", o = objMain.playerGroup.children[a], n = .0025 * objMain.mainF.getLength(objMain.camera.position, r) / 10, n = Math.max(n, .0015))) : (r = objMain.playerGroup.children[a].position, s = new THREE.Vector3(r.x - objMain.camera.position.x, r.y - objMain.camera.position.y, r.z - objMain.camera.position.z), .984807753 < (l = objMain.raycasterOfSelector.ray.direction.dot(s) / s.length() / objMain.raycasterOfSelector.ray.direction.length()) && i < l && (i = l, t = "attack", o = objMain.playerGroup.children[a], n = .0025 * objMain.mainF.getLength(objMain.camera.position, r) / 10, n = Math.max(n, .0015)))); for (a = 0; a < objMain.promoteDiamond.children.length; a++)if (objMain.promoteDiamond.children[a].isMesh) { var r = objMain.promoteDiamond.children[a].position, s = new THREE.Vector3(r.x - objMain.camera.position.x, r.y - objMain.camera.position.y, r.z - objMain.camera.position.z), l = objMain.raycasterOfSelector.ray.direction.dot(s) / s.length() / objMain.raycasterOfSelector.ray.direction.length(); if (.984807753 < l && i < l) switch (i = l, o = objMain.promoteDiamond.children[a], n = objMain.mainF.getLength(objMain.camera.position, r) / 20, n = Math.max(n, .2), o.name) { case "diamond_mile": t = "mile"; break; case "diamond_business": t = "business"; break; case "diamond_volume": t = "volume"; break; case "diamond_speed": t = "speed" } } for (a = 0; a < objMain.buildingGroup.children.length; a++)objMain.buildingGroup.visible && (r = objMain.buildingGroup.children[a].position, s = new THREE.Vector3(r.x - objMain.camera.position.x, r.y - objMain.camera.position.y, r.z - objMain.camera.position.z), .984807753 < (l = objMain.raycasterOfSelector.ray.direction.dot(s) / s.length() / objMain.raycasterOfSelector.ray.direction.length()) && i < l && (i = l, t = "building", o = objMain.buildingGroup.children[a])); for (a = 0; a < objMain.columnGroup.children.length; a++)if (objMain.columnGroup.children[a].isMesh) { r = objMain.columnGroup.children[a].position, s = new THREE.Vector3(r.x - objMain.camera.position.x, r.y - objMain.camera.position.y, r.z - objMain.camera.position.z), l = objMain.raycasterOfSelector.ray.direction.dot(s) / s.length() / objMain.raycasterOfSelector.ray.direction.length(); if (.984807753 < l && i < l) if (i = l, "waitAtBaseStation" == objMain.carState.car) if (k < 4) switch ((o = objMain.columnGroup.children[a]).name) { case "BatteryMile": case "BatteryBusiness": case "BatteryVolume": case "BatterySpeed": t = "ability" } else o = objMain.playerGroup.getObjectByName("flag_" + objMain.indexKey), t = "setReturn", n = .0025 * objMain.mainF.getLength(objMain.camera.position, r) / 10, n = Math.max(n, .0015); else o = objMain.playerGroup.getObjectByName("flag_" + objMain.indexKey), t = "setReturn", n = .0025 * objMain.mainF.getLength(objMain.camera.position, r) / 10, n = Math.max(n, .0015) } switch (objMain.Task.state = t, objMain.Task.state) { case "collect": o.scale.set(n, n, n), objMain.selectObj.obj = o, objMain.selectObj.type = objMain.Task.state, o.rotation.set(-Math.PI / 2, 0, Date.now() % 600 / 600 * Math.PI * 2); var c, d = o.userData.collectPosition; (c = document.createElement("div")).style.width = "10em", c.style.marginTop = "3em"; var b = "#ff0000"; c.style.border = "2px solid " + b, c.style.borderTopLeftRadius = "0.5em", c.style.backgroundColor = "rgba(245, 255, 179, 0.9)", c.style.color = "#1504f6", (m = document.createElement("div")).style.fontSize = "0.5em", (M = document.createElement("b")).innerHTML = "到" + d.Fp.region + '[<span style="color:#02020f">' + d.Fp.FastenPositionName + '</span>]回收<span style="color:#02020f">' + d.collectMoney.toFixed(2) + "元</span>现金。", m.appendChild(M), c.appendChild(m); var u = new THREE.CSS2DObject(c), p = d.Fp; u.position.set(MercatorGetXbyLongitude(p.Longitude), MercatorGetZbyHeight(p.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(p.Latitde)), objMain.groupOfOperatePanle.add(u); break; case "ability": objMain.selectObj.obj = o, objMain.selectObj.type = objMain.Task.state, o.scale.setX(Date.now() % 2e3 / 2e3 + 1), o.scale.setZ(Date.now() % 2e3 / 2e3 + 1), (c = document.createElement("div")).style.width = "10em", c.style.marginTop = "3em"; b = "#ff0000"; c.style.border = "2px solid " + b, c.style.borderTopLeftRadius = "0.5em", c.style.backgroundColor = "rgba(245, 255, 179, 0.9)", c.style.color = "#1504f6", (m = document.createElement("div")).style.fontSize = "0.5em"; var M = document.createElement("b"); switch (o.name) { case "BatteryMile": M.innerHTML = "红宝石市价:" + (objMain.diamondPrice.mile / 100).toFixed(2) + "银两。用其提升最大里程。你有" + objMain.PromoteDiamondCount.mile + "块"; break; case "BatteryBusiness": M.innerHTML = "绿宝石市价:" + (objMain.diamondPrice.business / 100).toFixed(2) + "银两。用其提升最大业务能力。你有" + objMain.PromoteDiamondCount.business + "块"; break; case "BatteryVolume": M.innerHTML = "蓝宝石市价:" + (objMain.diamondPrice.volume / 100).toFixed(2) + "银两。用其提升最大收集能力。你有" + objMain.PromoteDiamondCount.volume + "块"; break; case "BatterySpeed": M.innerHTML = "黑宝石市价:" + (objMain.diamondPrice.speed / 100).toFixed(2) + "银两。用其提升速度。你有" + objMain.PromoteDiamondCount.speed + "块" }m.appendChild(M), c.appendChild(m), (u = new THREE.CSS2DObject(c)).position.set(o.position.x, o.position.y, o.position.z), objMain.groupOfOperatePanle.add(u); break; case "setReturn": o.scale.set(n, n, n), objMain.selectObj.obj = o, objMain.selectObj.type = objMain.Task.state, o.rotation.set(-Math.PI / 2, 0, Date.now() % 300 / 300 * Math.PI * 2), (c = document.createElement("div")).style.width = "10em", c.style.marginTop = "3em"; b = "#ff0000"; c.style.border = "2px solid " + b, c.style.borderTopLeftRadius = "0.5em", c.style.backgroundColor = "rgba(245, 255, 179, 0.9)", c.style.color = "#1504f6", (m = document.createElement("div")).style.fontSize = "0.5em", (M = document.createElement("b")).innerHTML = "回到基地->" + objMain.basePoint.FastenPositionName + "(" + objMain.basePoint.Longitude.toFixed(2) + "," + objMain.basePoint.Latitde.toFixed(2) + ")", m.appendChild(M), c.appendChild(m), (u = new THREE.CSS2DObject(c)).position.set(o.position.x, o.position.y, o.position.z), objMain.groupOfOperatePanle.add(u); break; case "attack": o.scale.set(n, n, n), objMain.selectObj.obj = o, objMain.selectObj.type = objMain.Task.state, o.rotation.set(-Math.PI / 2, 0, Date.now() % 300 / 300 * Math.PI * 2), (c = document.createElement("div")).style.width = "10em", c.style.marginTop = "3em"; var m, b = "#ff0000"; c.style.border = "2px solid " + b, c.style.borderTopLeftRadius = "0.5em", c.style.backgroundColor = "rgba(245, 255, 179, 0.9)", c.style.color = "#1504f6", (m = document.createElement("div")).style.fontSize = "0.5em"; M = document.createElement("b"), b = o.name.substring(5); null == objMain.othersBasePoint[b] ? M.innerHTML = "攻击" : objMain.othersBasePoint[b].isNPC ? M.innerHTML = M.innerHTML = "到(" + objMain.othersBasePoint[b].basePoint.region + ")" + objMain.othersBasePoint[b].basePoint.FastenPositionName + "(" + objMain.othersBasePoint[b].basePoint.Longitude.toFixed(2) + "," + objMain.othersBasePoint[b].basePoint.Latitde.toFixed(2) + ")攻击NPC【" + objMain.othersBasePoint[b].playerName + "】(" + objMain.othersBasePoint[b].Level + "级)" : objMain.othersBasePoint[b].isPlayer ? M.innerHTML = "到(" + objMain.othersBasePoint[b].basePoint.region + ")" + objMain.othersBasePoint[b].basePoint.FastenPositionName + "(" + objMain.othersBasePoint[b].basePoint.Longitude.toFixed(2) + "," + objMain.othersBasePoint[b].basePoint.Latitde.toFixed(2) + ")攻击玩家【" + objMain.othersBasePoint[b].playerName + "】(" + objMain.othersBasePoint[b].Level + "级)" : M.innerHTML = "攻击", m.appendChild(M), c.appendChild(m), (u = new THREE.CSS2DObject(c)).position.set(o.position.x, o.position.y, o.position.z), objMain.groupOfOperatePanle.add(u); break; case "mile": case "business": case "volume": case "speed": objMain.selectObj.obj = o, objMain.selectObj.type = objMain.Task.state, o.scale.set(n, 1.1 * n, n); var p = o.userData.Fp, j = MercatorGetZbyHeight(p.Height); o.position.y = j + Math.sin(Date.now() % 3e3 / 3e3 * Math.PI) * n / 4, o.rotation.y = Date.now() % 8e3 / 8e3 * Math.PI * 2; break; case "building": objMain.selectObj.obj = o, objMain.selectObj.type = objMain.Task.state, "building" == objMain.selectObj.obj.userData.modelType && (2e3 < (j = Date.now() % 4e3) ? (o.scale.setX(-.05 * Math.sin(j % 2e3 / 2e3 * Math.PI * 2) + 1), o.scale.setZ(-.05 * Math.sin(j % 2e3 / 2e3 * Math.PI * 2) + 1)) : (o.scale.setX(-.1 * Math.sin(j % 2e3 / 2e3 * Math.PI * 2) + 1), o.scale.setZ(-.1 * Math.sin(j % 2e3 / 2e3 * Math.PI * 2) + 1))) } } else objMain.Task.state = ""; for (a = 0; a < objMain.playerGroup.children.length; a++)objMain.playerGroup.children[a].isMesh && (objMain.playerGroup.children[a].userData.animateDataYrq.simulate(Date.now()), objMain.playerGroup.children[a].userData.animateDataYrq.refresh(Date.now())); for (a = 0; a < objMain.carGroup.children.length; a++)objMain.carGroup.children[a].isGroup && ((n = .001 * k) < .002 && (n = .002), objMain.carGroup.children[a].scale.set(n, n, n), objMain.carGroup.children[1].name.split("_")[1], stateSet.speed.Animate(objMain.carGroup.children[a].name.split("_")[1]), stateSet.attck.Animate(objMain.carGroup.children[a].name.split("_")[1]), stateSet.confuse.Animate(objMain.carGroup.children[a].name.split("_")[1]), stateSet.lost.Animate(objMain.carGroup.children[a].name.split("_")[1])); (n = .001 * k) < .002 && (n = .002), "" != objMain.Task.carSelect && null != objMain.carGroup.getObjectByName(objMain.Task.carSelect) && objMain.carGroup.getObjectByName(objMain.Task.carSelect).scale.set(n, n, n); for (var h, g = !1, y = Object.keys(objMain.carsAnimateData), a = 0; a < y.length; a++) { var f = y[a], w = objMain.carsAnimateData[f], E = w.previous, P = w.current, S = f == "car_" + objMain.indexKey, G = Date.now(), w = !1; null != E && (w = animationF(f, E, G, S, k)), null == P || w || (w = animationF(f, P, G, S, k)), w && S && (g = !0) } if ("selecting" == objMain.carState.car ? (objMain.directionGroup.visible = !0, objMain.directionGroup.children.length) : objMain.directionGroup.visible = !1, objMain.controls.maxPolarAngle = Math.PI / 2 + Math.PI / 3, g ? (h = 0, objMain.carGroup.getObjectByName("car_" + objMain.indexKey) && (h = objMain.carGroup.getObjectByName("car_" + objMain.indexKey).position.y), sceneYUpdate(h), objMain.heightLevel = h) : null != objMain.camaraAnimateData ? (sceneYUpdate(e), objMain.heightLevel = e) : sceneYUpdate(objMain.heightLevel), moneyAbsorb.animate(), targetShow.animate(), objMain.animation.animateCameraByCarAndTask(), theLagestHoderKey.animate(), objMain.renderer.render(objMain.scene, objMain.camera), objMain.labelRenderer.render(objMain.scene, objMain.camera), objMain.light1.position.set(objMain.camera.position.x + k / 3, objMain.camera.position.y, objMain.camera.position.z + k / 3), objMain.directionGroup.visible) { for (var T = Math.PI / 20, O = -1, a = 1; a < objMain.directionGroup.children.length; a++) { objMain.directionGroup.children[a].children[0].material = objMain.ModelInput.directionArrow.oldM; var v = (objMain.directionGroup.children[a].rotation.y - (objMain.controls.getAzimuthalAngle() + Math.PI / 2) + 2 * Math.PI) % (2 * Math.PI); v < T && (T = v, O = a) } 0 < O && (objMain.directionGroup.children[O].children[0].material = objMain.ModelInput.directionArrow.newM) } } break; case "LookForBuildings": null != objMain.transtractionData && (objMain.camera.lookAt(objMain.transtractionData.x, objMain.transtractionData.y, objMain.transtractionData.z), objMain.controls.target.set(objMain.transtractionData.x, objMain.transtractionData.y, objMain.transtractionData.z)), objMain.renderer.render(objMain.scene, objMain.camera), objMain.labelRenderer.render(objMain.scene, objMain.camera), objMain.light1.position.set(objMain.camera.position.x, objMain.camera.position.y, objMain.camera.position.z); break; case "QueryReward": var k; null != objMain.renderer && objMain.renderer.render(objMain.scene, objMain.camera), null != objMain.labelRenderer && objMain.labelRenderer.render(objMain.scene, objMain.camera), null != objMain.renderer && (k = objMain.mainF.getLength(objMain.camera.position, objMain.controls.target), animateDetailF.moveCamara(k), objMain.light1.position.set(objMain.camera.position.x + k / 3, objMain.camera.position.y, objMain.camera.position.z + k / 3)) }100 < Date.now() - objMain.pingTime && (objMain.pingTime = Date.now()) } startA(), window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame, animate(); var animateDetailF = { moveCamara: function (e) { if (null == objMain.camaraAnimateData) return 0; if (objMain.camaraAnimateData.newT.t < Date.now()) return objMain.camaraAnimateData = null, 0; var a = (Date.now() - objMain.camaraAnimateData.old.t) / 3e3 * Math.PI, t = (Math.sin(a - Math.PI / 2) + 1) / 2, n = objMain.camaraAnimateData.old.x + (objMain.camaraAnimateData.newT.x - objMain.camaraAnimateData.old.x) * t, o = objMain.camaraAnimateData.old.y + (objMain.camaraAnimateData.newT.y - objMain.camaraAnimateData.old.y) * t, i = objMain.camaraAnimateData.old.z + (objMain.camaraAnimateData.newT.z - objMain.camaraAnimateData.old.z) * t; objMain.controls.target.set(n, o, i); var r = objMain.controls.getPolarAngle(), a = e, t = Math.abs(a * Math.cos(r)), e = a * Math.sin(r), a = objMain.controls.getAzimuthalAngle(), r = e * Math.sin(a), a = e * Math.cos(a); return objMain.camera.position.set(n + r, o + t, i + a), objMain.camera.lookAt(n, o, i), o } }, selectSingleTeamJoinHtml = function () { document.getElementById("rootContainer").innerHTML = selectSingleTeamJoinHtmlF.drawHtml() }, buttonClick = function (e) { if ("selectSingleTeamJoin" == objMain.receivedState) switch (e) { case "single": objMain.ws.send(JSON.stringify({ c: "JoinGameSingle", RefererAddr: nyrqUrl.get() })), objMain.receivedState = ""; break; case "team": objMain.ws.send(JSON.stringify({ c: "CreateTeam", RefererAddr: nyrqUrl.get() })), objMain.receivedState = ""; break; case "join": objMain.ws.send(JSON.stringify({ c: "JoinTeam" })), objMain.receivedState = ""; break; case "setName": objMain.receivedState = "setName", selectSingleTeamJoinHtmlF.setNameHtmlShow(), objMain.ws.send(JSON.stringify({ c: "GetName" })); break; case "setCarsName": objMain.receivedState = "setCarsName", selectSingleTeamJoinHtmlF.setCarsNameHtmlShow(), objMain.ws.send(JSON.stringify({ c: "GetCarsName" })); break; case "QueryReward": objMain.ws.send(JSON.stringify({ c: "QueryReward" })); break; case "HelpAndGuide": objMain.ws.send(JSON.stringify({ c: "Guid" })) } }, QueryReward = { draw3D: function () { document.getElementById("rootContainer").innerHTML = ""; var e = document.createElement("div"); e.id = "mainC", e.className = "container", document.getElementById("rootContainer").appendChild(e), objMain.scene = new THREE.Scene; var a = new THREE.CubeTextureLoader; a.setPath("Pic/"); e = a.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"]); objMain.scene.background = e, objMain.renderer = new THREE.WebGLRenderer({ alpha: !0 }), objMain.renderer.setClearColor(0, 0), objMain.renderer.setPixelRatio(window.devicePixelRatio), objMain.renderer.setSize(window.innerWidth, window.innerHeight), objMain.renderer.domElement.className = "renderDom", document.getElementById("mainC").appendChild(objMain.renderer.domElement), objMain.labelRenderer = new THREE.CSS2DRenderer, objMain.labelRenderer.setSize(window.innerWidth, window.innerHeight), objMain.labelRenderer.domElement.className = "labelRenderer", document.getElementById("mainC").appendChild(objMain.labelRenderer.domElement), objMain.camera = new THREE.PerspectiveCamera(35, 1, .1, 3e4), objMain.camera.position.set(4e3, 2e3, 0), objMain.camera.position.set(MercatorGetXbyLongitude(objMain.centerPosition.lon), 20, -MercatorGetYbyLatitude(objMain.centerPosition.lat)), objMain.controls = new THREE.OrbitControls(objMain.camera, objMain.labelRenderer.domElement), objMain.controls.center.set(MercatorGetXbyLongitude(objMain.centerPosition.lon), 0, -MercatorGetYbyLatitude(objMain.centerPosition.lat)), objMain.roadGroup = new THREE.Group, objMain.scene.add(objMain.roadGroup), objMain.playerGroup = new THREE.Group, objMain.scene.add(objMain.playerGroup), objMain.promoteDiamond = new THREE.Group, objMain.scene.add(objMain.promoteDiamond), objMain.columnGroup = new THREE.Group, objMain.scene.add(objMain.columnGroup), objMain.carGroup = new THREE.Group, objMain.scene.add(objMain.carGroup), objMain.groupOfOperatePanle = new THREE.Group, objMain.scene.add(objMain.groupOfOperatePanle), objMain.collectGroup = new THREE.Group, objMain.scene.add(objMain.collectGroup), objMain.getOutGroup = new THREE.Group, objMain.scene.add(objMain.getOutGroup), objMain.taxGroup = new THREE.Group, objMain.scene.add(objMain.taxGroup), objMain.shieldGroup = new THREE.Group, objMain.scene.add(objMain.shieldGroup), objMain.confusePrepareGroup = new THREE.Group, objMain.scene.add(objMain.confusePrepareGroup), objMain.lostPrepareGroup = new THREE.Group, objMain.scene.add(objMain.lostPrepareGroup), objMain.ambushPrepareGroup = new THREE.Group, objMain.scene.add(objMain.ambushPrepareGroup), objMain.waterGroup = new THREE.Group, objMain.scene.add(objMain.waterGroup), objMain.fireGroup = new THREE.Group, objMain.scene.add(objMain.fireGroup), objMain.lightningGroup = new THREE.Group, objMain.scene.add(objMain.lightningGroup), objMain.directionGroup = new THREE.Group, objMain.scene.add(objMain.directionGroup), objMain.buildingGroup = new THREE.Group, objMain.scene.add(objMain.buildingGroup), objMain.clock = new THREE.Clock, objMain.light1 = new THREE.PointLight(16777215), objMain.light1.position.set(-100, 300, -100), objMain.light1.intensity = 2, objMain.scene.add(objMain.light1), objMain.controls.minPolarAngle = Math.PI / 600, objMain.controls.maxPolarAngle = Math.PI / 2 - Math.PI / 36, objMain.controls.minDistance = 2, objMain.controls.maxDistance = 256, objMain.raycaster = new THREE.Raycaster, objMain.raycaster.linePrecision = .2, objMain.raycasterOfSelector = new THREE.Raycaster, objMain.mouse = new THREE.Vector2; a = function (e) { operatePanel.refresh() }, e = function (e) { objMain.canSelect = !0, objMain.music.change() }; objMain.labelRenderer.domElement.addEventListener("mouseup", a, !1), objMain.labelRenderer.domElement.addEventListener("mousedown", e, !1), objMain.labelRenderer.domElement.addEventListener("touchstart", e, !1), objMain.labelRenderer.domElement.addEventListener("touchend", a, !1), window.addEventListener("resize", onWindowResize, !1), onWindowResize() }, lookAt: function () { var e; "QueryReward" == objMain.state && (e = objMain.buildingGroup.children[0], e = { old: { x: objMain.controls.target.x, y: objMain.controls.target.y, z: objMain.controls.target.z, t: Date.now() }, newT: { x: e.position.x, y: e.position.y, z: e.position.z, t: Date.now() + 3e3 } }, objMain.camaraAnimateData = e) }, drawToolBar: function (e) { if ("QueryReward" == objMain.state) { for (; null != document.getElementById("sysOperatePanel");)document.getElementById("sysOperatePanel").remove(); var a = document.createElement("div"); a.id = "sysOperatePanel", a.style.position = "absolute", a.style.zIndex = "7", a.style.top = "calc(100% - 2.5em - 8px)", a.style.left = "8px", a.style.width = "calc(100% - 16px)"; var t = document.createElement("img"); t.id = "QueryRewardExit", t.src = "Pic/settingIcon.png", t.classList.add("chatdialog"), t.style.border = "solid 1px orange", t.style.borderRadius = "5px", t.style.height = "calc(2.5em - 2px)", t.style.width = "auto", t.style.marginLeft = "calc(100% - 2.5em - 2px)", t.onclick = function () { for (; null != document.getElementById("sysOperatePanel");)document.getElementById("sysOperatePanel").remove(); objMain.mainF.removeF.clearGroup(objMain.roadGroup), MapData.meshPoints = [], objMain.mainF.removeF.clearGroup(objMain.buildingGroup), objMain.renderer = null, objMain.labelRenderer = null, document.getElementById("rootContainer").innerHTML = "", objMain.ws.send(JSON.stringify({ c: "RewardInfomation", Page: reward.page })) }, a.appendChild(t), document.body.appendChild(a) } } }, setTransactionHtml = { bussinessAddress: "", draw3D: function () { document.getElementById("rootContainer").innerHTML = ""; var e = document.createElement("div"); e.id = "mainC", e.className = "container_Show", document.getElementById("rootContainer").appendChild(e), document.getElementById("rootContainer").style.overflow = "scroll", objMain.scene = new THREE.Scene; var a = new THREE.CubeTextureLoader; a.setPath("Pic/"); e = a.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"]); objMain.scene.background = e, objMain.renderer = new THREE.WebGLRenderer({ alpha: !0 }), objMain.renderer.setClearColor(0, 0), objMain.renderer.setPixelRatio(window.devicePixelRatio), objMain.renderer.setSize(300, 300), objMain.renderer.domElement.className = "renderDom_Trans", document.getElementById("mainC").appendChild(objMain.renderer.domElement), objMain.labelRenderer = new THREE.CSS2DRenderer, objMain.labelRenderer.setSize(300, 300), objMain.labelRenderer.domElement.className = "labelRenderer_Trans", document.getElementById("mainC").appendChild(objMain.labelRenderer.domElement), objMain.camera = new THREE.PerspectiveCamera(35, 1, .1, 3e4), objMain.camera.position.set(4e3, 2e3, 0), objMain.camera.position.set(MercatorGetXbyLongitude(objMain.centerPosition.lon), 20, -MercatorGetYbyLatitude(objMain.centerPosition.lat)), objMain.controls = new THREE.OrbitControls(objMain.camera, objMain.labelRenderer.domElement), objMain.controls.center.set(MercatorGetXbyLongitude(objMain.centerPosition.lon), 0, -MercatorGetYbyLatitude(objMain.centerPosition.lat)), objMain.roadGroup = new THREE.Group, objMain.scene.add(objMain.roadGroup), objMain.playerGroup = new THREE.Group, objMain.scene.add(objMain.playerGroup), objMain.promoteDiamond = new THREE.Group, objMain.scene.add(objMain.promoteDiamond), objMain.columnGroup = new THREE.Group, objMain.scene.add(objMain.columnGroup), objMain.carGroup = new THREE.Group, objMain.scene.add(objMain.carGroup), objMain.groupOfOperatePanle = new THREE.Group, objMain.scene.add(objMain.groupOfOperatePanle), objMain.collectGroup = new THREE.Group, objMain.scene.add(objMain.collectGroup), objMain.getOutGroup = new THREE.Group, objMain.scene.add(objMain.getOutGroup), objMain.taxGroup = new THREE.Group, objMain.scene.add(objMain.taxGroup), objMain.shieldGroup = new THREE.Group, objMain.scene.add(objMain.shieldGroup), objMain.confusePrepareGroup = new THREE.Group, objMain.scene.add(objMain.confusePrepareGroup), objMain.lostPrepareGroup = new THREE.Group, objMain.scene.add(objMain.lostPrepareGroup), objMain.ambushPrepareGroup = new THREE.Group, objMain.scene.add(objMain.ambushPrepareGroup), objMain.waterGroup = new THREE.Group, objMain.scene.add(objMain.waterGroup), objMain.fireGroup = new THREE.Group, objMain.scene.add(objMain.fireGroup), objMain.lightningGroup = new THREE.Group, objMain.scene.add(objMain.lightningGroup), objMain.directionGroup = new THREE.Group, objMain.scene.add(objMain.directionGroup), objMain.buildingGroup = new THREE.Group, objMain.scene.add(objMain.buildingGroup), objMain.clock = new THREE.Clock, objMain.light1 = new THREE.PointLight(16777215), objMain.light1.position.set(-100, 300, -100), objMain.light1.intensity = 2, objMain.scene.add(objMain.light1), objMain.controls.minPolarAngle = Math.PI / 600, objMain.controls.maxPolarAngle = Math.PI / 2 - Math.PI / 36, objMain.controls.minDistance = 2, objMain.controls.maxDistance = 256, objMain.raycaster = new THREE.Raycaster, objMain.raycaster.linePrecision = .2, objMain.raycasterOfSelector = new THREE.Raycaster, objMain.mouse = new THREE.Vector2; a = function (e) { operatePanel.refresh() }, e = function (e) { objMain.canSelect = !0, objMain.music.change() }; objMain.labelRenderer.domElement.addEventListener("mouseup", a, !1), objMain.labelRenderer.domElement.addEventListener("mousedown", e, !1), objMain.labelRenderer.domElement.addEventListener("touchstart", e, !1), objMain.labelRenderer.domElement.addEventListener("touchend", a, !1), window.addEventListener("resize", onWindowResize, !1) }, change: function () { "LookForBuildings" === objMain.state ? (document.getElementById("mainC").classList.add("small"), objMain.renderer.setSize(300, 300), objMain.labelRenderer.setSize(300, 300), objMain.camera.aspect = 1) : (document.getElementById("mainC").classList.remove("small"), objMain.labelRenderer.setSize(window.innerWidth, window.innerHeight), objMain.renderer.setSize(window.innerWidth, window.innerHeight), objMain.camera.aspect = window.innerWidth / window.innerHeight), objMain.camera.updateProjectionMatrix() }, drawAddr: function (e) { transactionBussiness().drawAddr(e), setTransactionHtml.bussinessAddress = e }, drawAgreementEditor: function () { transactionBussiness().drawAgreementEditor() }, drawStockTable: function () { transactionBussiness().drawStockTable() }, drawTradeTable: function () { transactionBussiness().drawTradeTable() }, originalTable: function () { transactionBussiness().originalTable() }, generateAgreement: function () { objMain.ws.send(transactionBussiness().generateAgreement(setTransactionHtml.bussinessAddress)) }, transSign: function () { objMain.ws.send(transactionBussiness().transSign(setTransactionHtml.bussinessAddress)) }, editRootContainer: function () { transactionBussiness().editRootContainer() }, cancle: function () { transactionBussiness().Cancle(), transactionBussiness().notifyMsg(!1) } }, set3DHtml = function () { document.getElementById("rootContainer").innerHTML = ""; var e = document.createElement("div"); e.id = "mainC", e.className = "container", document.getElementById("rootContainer").appendChild(e), objMain.scene = new THREE.Scene; var a = new THREE.CubeTextureLoader; a.setPath("Pic/"); e = a.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"]); objMain.background.backgroundData.main = e, objMain.scene.background = objMain.background.backgroundData.main, objMain.renderer = new THREE.WebGLRenderer({ alpha: !0 }), objMain.renderer.setClearColor(0, 0), objMain.renderer.setPixelRatio(window.devicePixelRatio), objMain.renderer.setSize(window.innerWidth, window.innerHeight), objMain.renderer.domElement.className = "renderDom", document.getElementById("mainC").appendChild(objMain.renderer.domElement), objMain.labelRenderer = new THREE.CSS2DRenderer, objMain.labelRenderer.setSize(window.innerWidth, window.innerHeight), objMain.labelRenderer.domElement.className = "labelRenderer", document.getElementById("mainC").appendChild(objMain.labelRenderer.domElement), objMain.camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, .1, 3e4), objMain.camera.position.set(4e3, 2e3, 0), objMain.camera.position.set(MercatorGetXbyLongitude(objMain.centerPosition.lon), 20, -MercatorGetYbyLatitude(objMain.centerPosition.lat)), objMain.controls = new THREE.OrbitControls(objMain.camera, objMain.labelRenderer.domElement), objMain.controls.center.set(MercatorGetXbyLongitude(objMain.centerPosition.lon), 0, -MercatorGetYbyLatitude(objMain.centerPosition.lat)); a = function (e) { return e = new THREE.Group, objMain.scene.add(e), e }; objMain.roadGroup = a(objMain.roadGroup), objMain.playerGroup = a(objMain.playerGroup), objMain.promoteDiamond = a(objMain.promoteDiamond), objMain.columnGroup = a(objMain.columnGroup), objMain.carGroup = a(objMain.carGroup), objMain.groupOfOperatePanle = a(objMain.groupOfOperatePanle), objMain.collectGroup = a(objMain.collectGroup), objMain.getOutGroup = a(objMain.getOutGroup), objMain.taxGroup = a(objMain.taxGroup), objMain.shieldGroup = a(objMain.shieldGroup), objMain.confusePrepareGroup = a(objMain.confusePrepareGroup), objMain.lostPrepareGroup = a(objMain.lostPrepareGroup), objMain.ambushPrepareGroup = a(objMain.ambushPrepareGroup), objMain.waterGroup = a(objMain.waterGroup), objMain.waterMarkGroup = a(objMain.waterMarkGroup), objMain.fireGroup = a(objMain.fireGroup), objMain.fireMarkGroup = a(objMain.fireGroup), objMain.lightningGroup = a(objMain.lightningGroup), objMain.lightningMarkGroup = a(objMain.lightningMarkGroup), objMain.absorbGroup = a(objMain.absorbGroup), objMain.directionGroup = a(objMain.directionGroup), objMain.buildingGroup = a(objMain.buildingGroup), objMain.targetGroup = a(objMain.targetGroup), objMain.buildingSelectionGroup = a(objMain.buildingSelectionGroup), objMain.fightSituationGroup = a(objMain.fightSituationGroup), objMain.groupOfTaskCopy = a(objMain.groupOfTaskCopy), objMain.clock = new THREE.Clock, objMain.light1 = new THREE.PointLight(16777215), objMain.light1.position.set(-100, 300, -100), objMain.light1.intensity = 2, objMain.scene.add(objMain.light1), objMain.controls.minPolarAngle = Math.PI / 600, objMain.controls.maxPolarAngle = Math.PI / 2 - Math.PI / 36, objMain.controls.minDistance = 2, objMain.controls.maxDistance = 256, objMain.raycaster = new THREE.Raycaster, objMain.raycaster.linePrecision = .2, objMain.raycasterOfSelector = new THREE.Raycaster, objMain.mouse = new THREE.Vector2; e = function (e) { if (operatePanel.refresh(), objMain.directionGroup.visible) { for (var a, t = Math.PI / 20, n = -1, o = 1; o < objMain.directionGroup.children.length; o++) { var i = (objMain.directionGroup.children[o].rotation.y - (objMain.controls.getAzimuthalAngle() + Math.PI / 2) + 4 * Math.PI) % (2 * Math.PI); i < t && (t = i, n = o) } 0 < n && (a = objMain.directionGroup.children[n].rotation.y, a = JSON.stringify({ c: "ViewAngle", rotationY: a }), objMain.ws.send(a)) } }, a = function (e) { objMain.canSelect = !0, objMain.music.change() }; objMain.labelRenderer.domElement.addEventListener("mouseup", e, !1), objMain.labelRenderer.domElement.addEventListener("mousedown", a, !1), objMain.labelRenderer.domElement.addEventListener("touchstart", a, !1), objMain.labelRenderer.domElement.addEventListener("touchend", e, !1), window.addEventListener("resize", onWindowResize, !1) }; function onWindowResize() { switch (objMain.state) { case "OnLine": objMain.camera.aspect = window.innerWidth / window.innerHeight, objMain.camera.updateProjectionMatrix(), objMain.labelRenderer.setSize(window.innerWidth, window.innerHeight), objMain.renderer.setSize(window.innerWidth, window.innerHeight), carAbility.refreshPosition(); break; case "LookForBuildings": objMain.camera.aspect = 1, objMain.camera.updateProjectionMatrix(), objMain.labelRenderer.setSize(300, 300), objMain.renderer.setSize(300, 300); break; case "QueryReward": objMain.camera.aspect = window.innerWidth / window.innerHeight, objMain.camera.updateProjectionMatrix(), objMain.labelRenderer.setSize(window.innerWidth, window.innerHeight), objMain.renderer.setSize(window.innerWidth, window.innerHeight) } } var MapData = { roadAndCrossJson: "", roadAndCross: null, meshPoints: [], initialize: function () { this.roadAndCross = "", this.roadAndCross = null, this.meshPoints = [] } }, drawPoint = function (e, a, t) { e = new function (e) { var u = this; this.windStrengthDelta = 0, this.DAMPING = .03, this.DRAG = 1 - this.DAMPING, this.MASS = .1, this.restDistance = 25, this.xSegs = 10, this.ySegs = 10; var n, o, i = (n = this.restDistance * this.xSegs, o = this.restDistance * this.ySegs, function (e, a, t) { e = (e - .5) * n, a = (a + .5) * o; t.set(e, a, 0) }); var p = new function (t, n) { t = t || 10, n = n || 10, this.w = t, this.h = n; var o = [], i = []; for (let a = 0; a <= n; a++)for (let e = 0; e <= t; e++)o.push(new s(e / t, a / n, 0, u.MASS)); for (let a = 0; a < n; a++)for (let e = 0; e < t; e++)i.push([o[r(e, a)], o[r(e, a + 1)], u.restDistance]), i.push([o[r(e, a)], o[r(e + 1, a)], u.restDistance]); for (let e = t, a = 0; a < n; a++)i.push([o[r(e, a)], o[r(e, a + 1)], u.restDistance]); for (let e = n, a = 0; a < t; a++)i.push([o[r(a, e)], o[r(a + 1, e)], u.restDistance]); function r(e, a) { return e + a * (t + 1) } this.particles = o, this.constraints = i, this.index = r }(this.xSegs, this.ySegs); function s(e, a, t, n) { this.position = new THREE.Vector3, this.previous = new THREE.Vector3, this.original = new THREE.Vector3, this.a = new THREE.Vector3(0, 0, 0), this.mass = n, this.invMass = 1 / n, this.tmp = new THREE.Vector3, this.tmp2 = new THREE.Vector3, i(e, a, this.position), i(e, a, this.previous), i(e, a, this.original) } this.cloth = p, this.GRAVITY = 981 * 1.4, this.gravity = new THREE.Vector3(0, -this.GRAVITY, 0).multiplyScalar(this.MASS), this.TIMESTEP = .018, this.TIMESTEP_SQ = this.TIMESTEP * this.TIMESTEP, this.pins = [], this.windForce = new THREE.Vector3(0, 0, 0), this.tmpForce = new THREE.Vector3, s.prototype.addForce = function (e) { this.a.add(this.tmp2.copy(e).multiplyScalar(this.invMass)) }, s.prototype.integrate = function (e) { var a = this.tmp.subVectors(this.position, this.previous); a.multiplyScalar(u.DRAG).add(this.position), a.add(this.a.multiplyScalar(e)), this.tmp = this.previous, this.previous = this.position, this.position = a, this.a.set(0, 0, 0) }, this.diff = new THREE.Vector3, this.simulate = function (e) { var a = 20 * Math.cos(e / 7e3) + 40 + u.windStrengthDelta; u.windForce.set(Math.sin(e / 2e3), Math.cos(e / 3e3), Math.sin(e / 1e3)), u.windForce.normalize(), u.windForce.multiplyScalar(a); var n = p.particles; { let t; var o = new THREE.Vector3, i = M.index, r = M.attributes.normal; for (let a = 0, e = i.count; a < e; a += 3)for (let e = 0; e < 3; e++)t = i.getX(a + e), o.fromBufferAttribute(r, t), u.tmpForce.copy(o).normalize().multiplyScalar(o.dot(u.windForce)), n[t].addForce(u.tmpForce) } for (let e = 0, a = n.length; e < a; e++)(c = n[e]).addForce(u.gravity), c.integrate(u.TIMESTEP_SQ); var t = p.constraints, s = t.length; for (let e = 0; e < s; e++) { var l = t[e]; !function (e, a, t) { u.diff.subVectors(a.position, e.position); var n = u.diff.length(); 0 !== n && (n = u.diff.multiplyScalar(1 - t / n).multiplyScalar(.5), e.position.add(n), a.position.sub(n)) }(l[0], l[1], l[2]) } for (let e = 0, a = n.length; e < a; e++) { var c, d = (c = n[e]).position; d.y < -250 && (d.y = -250) } for (let e = 0, a = u.pins.length; e < a; e++) { var b = n[u.pins[e]]; b.position.copy(b.original), b.previous.copy(b.original) } }, this.pinsFormation = [], this.pins = [6], this.pinsFormation.push(this.pins), this.pins = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], this.pinsFormation.push(this.pins), this.pins = [0], this.pinsFormation.push(this.pins), this.pins = [], this.pinsFormation.push(this.pins), this.pins = [0, p.w], this.pinsFormation.push(this.pins), this.pins = this.pinsFormation[1], this.clothMaterial = new THREE.MeshLambertMaterial({ side: THREE.DoubleSide, alphaTest: .5, color: e, emissive: e }); var M = new THREE.ParametricBufferGeometry(i, p.w, p.h); return this.clothGeometry = M, this.refresh = function () { var t = u.cloth.particles; for (let e = 0, a = t.length; e < a; e++) { var n = t[e].position; u.clothGeometry.attributes.position.setXYZ(e, n.x, n.y, n.z) } u.clothGeometry.attributes.position.needsUpdate = !0, u.clothGeometry.computeVertexNormals() }, this }(e); object = new THREE.Mesh(e.clothGeometry, e.clothMaterial), object.userData.animateDataYrq = e, object.position.set(MercatorGetXbyLongitude(a.Longitude), .1 + MercatorGetZbyHeight(a.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(a.Latitde)), object.scale.set(5e-4, 5e-4, 5e-4), objMain.playerGroup.add(object); e = new THREE.Vector3(MercatorGetXbyLongitude(a.Longitude), MercatorGetZbyHeight(a.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(a.Latitde)), a = new THREE.Vector3(MercatorGetXbyLongitude(a.positionLongitudeOnRoad), MercatorGetZbyHeight(a.Height) * objMain.heightAmplify, -MercatorGetYbyLatitude(a.positionLatitudeOnRoad)), e = new Complex(a.x - e.x, a.z - e.z); e.toOne(), object.rotateY(-e.toAngle() + Math.PI / 2), object.name = "flag_" + t }, SysOperatePanel = { draw: function () { for (; null != document.getElementById("sysOperatePanel");)document.getElementById("sysOperatePanel").remove(); var e, a = document.createElement("div"); a.id = "sysOperatePanel", a.style.position = "absolute", a.style.zIndex = "7", a.style.top = "calc(100% - 2.5em - 8px)", a.style.left = "8px", a.style.width = "calc(100% - 16px)", (e = document.createElement("img")).id = "msgToNotify", e.src = "Pic/chatPng.png", e.classList.add("chatdialog"), e.style.border = "solid 1px yellowgreen", e.style.borderRadius = "5px", e.style.height = "calc(2.5em - 2px)", e.style.width = "auto", e.onclick = function () { dialogSys.show() }, e.classList.add("costomButton"), a.appendChild(e), (e = document.createElement("img")).id = "moneyServe", e.src = "Pic/trade.png", e.classList.add("chatdialog"), e.style.border = "solid 1px yellowgreen", e.style.borderRadius = "5px", e.style.height = "calc(2.5em - 2px)", e.style.width = "auto", e.style.marginLeft = "0.5em", e.onclick = function () { moneyOperator.add() }, e.classList.add("costomButton"), a.appendChild(e), (e = document.createElement("img")).id = "moneySubsidize", e.src = "Pic/subsidize.png", e.classList.add("chatdialog"), e.style.border = "solid 1px yellowgreen", e.style.borderRadius = "5px", e.style.height = "calc(2.5em - 2px)", e.style.width = "auto", e.style.marginLeft = "0.5em", e.onclick = function () { subsidizeSys.add() }, e.classList.add("costomButton"), objMain.stateNeedToChange.isLogin || e.classList.add("msg"), a.appendChild(e), (e = document.createElement("img")).id = "moneySubsidize", e.src = "Pic/subsidize.png", e.classList.add("chatdialog"), e.style.border = "solid 1px yellowgreen", e.style.borderRadius = "5px", e.style.height = "calc(2.5em - 2px)", e.style.width = "auto", e.style.marginLeft = "0.5em", e.onclick = function () { "attack" == objMain.Task.state ? resistance.bindData(objMain.selectObj.obj.name.split("_")[1]) : resistance.bindData(objMain.indexKey) }, e.classList.add("costomButton"), a.appendChild(e), (e = document.createElement("img")).id = "gameFrontSetting", e.src = "Pic/settingIcon.png", e.classList.add("chatdialog"), e.style.border = "solid 1px yellowgreen", e.style.borderRadius = "5px", e.style.height = "calc(2.5em - 2px)", e.style.width = "auto", e.style.marginLeft = "calc(100% - 15em + 10px)", e.onclick = function () { "LookForBuildings" == objMain.state ? objMain.ws.send(JSON.stringify({ c: "CancleLookForBuildings" })) : settingSys.add() }, e.classList.add("costomButton"), a.appendChild(e), document.body.appendChild(a) }, notifyMsg: function () { document.getElementById("msgToNotify").classList.add("msg") }, cancelNotifyMsg: function () { document.getElementById("msgToNotify").classList.remove("msg") }, remove: function () { for (; null != document.getElementById("sysOperatePanel");)document.getElementById("sysOperatePanel").remove() } }, setWaitingToStart = function () { document.getElementById("rootContainer").innerHTML = "  <div>          请等待        </div>" }, token = { CommandStart: "" }, createTeam = function (e) { document.getElementById("rootContainer").innerHTML = ""; var a = document.createElement("div"); a.style.textAlign = "center"; function t(e, a, t) { var n = document.createElement("div"), o = document.createElement("label"), i = document.createElement("b"); return o.innerText = e, i.innerText = a, n.appendChild(o), n.appendChild(i), t && (n.style.background = "green", n.style.color = "yellow"), n } a.appendChild(t("房间号：", e.TeamNum)), a.appendChild(t(e.PlayerDetail.Description + "：", e.PlayerDetail.Name, !0)), document.getElementById("rootContainer").appendChild(a); e = document.createElement("div"); e.style.textAlign = "center"; var n = document.createElement("button"); n.innerText = "开始", n.style.width = "5em", n.style.height = "3em", n.style.marginTop = "1em"; a = document.createElement("div"); a.style.textAlign = "center"; var o = document.createElement("button"); o.innerText = "解散", o.style.width = "5em", o.style.height = "3em", o.style.marginTop = "5em", o.style.backgroundColor = "orange", o.onclick = function () { objMain.ws.send(token.CommandStart + "exit"), n.onclick = function () { }, o.onclick = function () { } }, n.onclick = function () { objMain.ws.send(token.CommandStart), n.onclick = function () { }, o.onclick = function () { } }, e.appendChild(n), a.appendChild(o), document.getElementById("rootContainer").appendChild(e), document.getElementById("rootContainer").appendChild(a) }, setWaitingToGetTeam = function () { document.getElementById("rootContainer").innerHTML = ""; var e = document.createElement("div"); e.style.textAlign = "center", e.style.marginTop = "2em"; var a = document.createElement("label"); a.innerText = "房间号"; var t = document.createElement("input"); t.id = "roomNumInput", t.type = "number", e.appendChild(a), e.appendChild(t), document.getElementById("rootContainer").appendChild(e); t = document.createElement("div"); t.style.textAlign = "center"; e = document.createElement("button"); e.innerText = "加入", e.style.width = "5em", e.style.height = "3em", e.style.marginTop = "1em", e.onclick = function () { console.log("提示", "加入事件还没有写写哦"); var e = document.getElementById("roomNumInput").value; "" == e ? alert("不要输入空") : (objMain.ws.send(e), this.onclick = function () { }) }, t.appendChild(e), document.getElementById("rootContainer").appendChild(t) }, joinTeamDetail = function (e) { document.getElementById("rootContainer").innerHTML = ""; var a = document.createElement("div"); a.style.textAlign = "center"; function t(e, a, t, n) { var o = document.createElement("div"), i = document.createElement("label"), r = document.createElement("b"); return i.innerText = e, r.innerText = a, o.appendChild(i), o.appendChild(r), null != t && null != t && "" != t && (o.id = t), n && (o.style.background = "green", o.style.color = "yellow"), o } a.appendChild(t("房间号：", e.TeamNum)), a.appendChild(t(e.Players[0].Description + "：", e.Players[0].Name, e.Players[0].GUID)); for (var n = 1; n < e.Players.length; n++)a.appendChild(t(e.Players[n].Description + "：", e.Players[n].Name, e.Players[n].GUID, e.Players[n].IsSelf)); document.getElementById("rootContainer").appendChild(a); var o = document.createElement("div"); o.style.textAlign = "center"; var i = document.createElement("button"); i.innerText = "离开房间", i.style.width = "5em", i.style.height = "3em", i.style.marginTop = "5em", i.style.backgroundColor = "orange", i.onclick = function () { objMain.ws.send(JSON.stringify({ c: "LeaveTeam" })) }, o.appendChild(i), document.getElementById("rootContainer").appendChild(o) }, broadTeamJoin = function (e) { var a, t, n, o, i, r; document.getElementById("rootContainer").children[0].appendChild((a = e.Player.Description + "：", t = e.Player.Name, n = e.Player.GUID, o = document.createElement("div"), i = document.createElement("label"), r = document.createElement("b"), i.innerText = a, r.innerText = t, o.appendChild(i), o.appendChild(r), null != n && null != n && "" != n && (o.id = n), o)) }, broadTeamMemberRemove = function (e) { for (; null != document.getElementById(e.Guid);)document.getElementById(e.Guid).remove() }, marketOperate = { refresh: function () { marketOperate.clearPanel(), marketOperate.state = "", "waitAtBaseStation" === objMain.carState.car && marketOperate.drawCarBtns() }, clearPanel: function () { for (; null != document.getElementById("taskOperatingPanel");)document.getElementById("taskOperatingPanel").remove() }, drawCarBtns: function () { (function () { var o = document.createElement("div"); o.id = "taskOperatingPanel", o.style.position = "absolute", o.style.zIndex = "7", o.style.right = "20px", o.style.border = "none", o.style.width = "5em", o.style.color = "green", o.style.top = "calc(50% - 3.25em - 20px)"; function e(e, a, t) { var n = document.createElement("div"); n.style.width = "calc(5em - 4px)", n.style.textAlign = "center", n.style.border = "2px inset #ffc403", n.style.borderRadius = "0.3em", n.style.marginTop = "4px", n.style.marginBottom = "4px", n.style.background = "rgba(0, 191, 255, 0.6)", n.style.height = "1.3em", n.id = a, (a = document.createElement("span")).innerText = e, n.appendChild(a), n.onclick = function () { t() }, o.appendChild(n) } e("宝石", "useGetDiamondBtn", function () { !function (e) { if (null != document.getElementById(e)) for (var a = document.getElementById(e); 0 < a.children.length;)a.children[0].remove() }("taskOperatingPanel"), e("购买", "buyDiamondBtn", function () { objMain.ws.send(JSON.stringify({ c: "BuyDiamond", pType: objMain.selectObj.obj.userData.index })) }), e("出售", "sellDiamondBtn", function () { objMain.ws.send(JSON.stringify({ c: "SellDiamond", pType: objMain.selectObj.obj.userData.index })) }), e("取消", "cancleBtn", function () { marketOperate.state = "", marketOperate.refresh() }) }), document.body.appendChild(o) })() }, state: "" }, operatePanel = { clearPanel: function () { for (; null != document.getElementById("taskOperatingPanel");)document.getElementById("taskOperatingPanel").remove() }, refresh: function () { operatePanel.clearPanel(); var o = document.createElement("div"); o.id = "taskOperatingPanel", o.style.position = "absolute", o.style.zIndex = "7", o.style.right = "20px", o.style.border = "none", o.style.width = "5em", o.style.color = "green", o.style.top = "calc(50% - 3.25em - 20px)"; function e(e, a, t) { var n = document.createElement("div"); n.style.width = "calc(5em - 4px)", n.style.textAlign = "center", n.style.border = "2px inset #ffc403", n.style.borderRadius = "0.3em", n.style.marginTop = "4px", n.style.marginBottom = "4px", n.style.background = "rgba(0, 191, 255, 0.6)", n.style.height = "1.3em", n.id = a, (a = document.createElement("span")).innerText = e, n.appendChild(a), n.onclick = function () { t() }, n.classList.add("costomButton"), o.appendChild(n) } document.body.appendChild(o); function a() { e("攻击", "attackBtn", function () { var e, a; objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (e = objMain.selectObj.obj.name.substring(5), null != objMain.othersBasePoint[e] && (a = objMain.othersBasePoint[e].fPIndex, objMain.ws.send(JSON.stringify({ c: "Attack", TargetOwner: e, Target: a }))), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }) } function t() { 0 < objMain.driver.driverIndex && (e(objMain.driver.skill1.name, "skill1Btn", function () { var e, a; objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (e = objMain.selectObj.obj.name.substring(5), null != objMain.othersBasePoint[e] ? (a = objMain.othersBasePoint[e].fPIndex, objMain.ws.send(JSON.stringify({ c: "Skill1", TargetOwner: e, Target: a }))) : "devil" == objMain.driver.race && objMain.indexKey == e && (a = objMain.fpIndex, objMain.ws.send(JSON.stringify({ c: "Skill1", TargetOwner: e, Target: a }))), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }), e(objMain.driver.skill2.name, "skill2Btn", function () { var e, a; objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (e = objMain.selectObj.obj.name.substring(5), null != objMain.othersBasePoint[e] ? (a = objMain.othersBasePoint[e].fPIndex, objMain.ws.send(JSON.stringify({ c: "Skill2", TargetOwner: e, Target: a }))) : "devil" == objMain.driver.race && objMain.indexKey == e && (a = objMain.fpIndex, objMain.ws.send(JSON.stringify({ c: "Skill2", TargetOwner: e, Target: a }))), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) })) } function n() { e("查看", "viewBtn", function () { var e; objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (objMain.selectObj.obj, e = { old: { x: objMain.controls.target.x, y: objMain.controls.target.y, z: objMain.controls.target.z, t: Date.now() }, newT: { x: objMain.selectObj.obj.position.x, y: objMain.selectObj.obj.position.y, z: objMain.selectObj.obj.position.z, t: Date.now() + 3e3 } }, objMain.heightLevel = objMain.selectObj.obj.position.y, objMain.camaraAnimateData = e, objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }) } function i() { e("求福", "buildingGetRewardBtn", function () { var e, a; objMain.canSelect = !1, "waitOnRoad" == objMain.carState.car ? (objMain.selectObj.obj, a = { old: { x: objMain.controls.target.x, y: objMain.controls.target.y, z: objMain.controls.target.z, t: Date.now() }, newT: { x: objMain.selectObj.obj.position.x, y: objMain.selectObj.obj.position.y, z: objMain.selectObj.obj.position.z, t: Date.now() + 3e3 } }, objMain.camaraAnimateData = a, null != objMain.selectObj.obj && (e = objMain.selectObj.obj.name, objMain.ws.send(JSON.stringify({ c: "GetRewardFromBuildings", selectObjName: e }))), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) : "waitAtBaseStation" == objMain.carState.car && (objMain.selectObj.obj, a = { old: { x: objMain.controls.target.x, y: objMain.controls.target.y, z: objMain.controls.target.z, t: Date.now() }, newT: { x: objMain.selectObj.obj.position.x, y: objMain.selectObj.obj.position.y, z: objMain.selectObj.obj.position.z, t: Date.now() + 3e3 } }, objMain.camaraAnimateData = a, objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh(), $.notify("在基地求福不能提升能力", "info")) }), e("详情", "buildingDetailBtn", function () { var e; objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (objMain.selectObj.obj, e = { old: { x: objMain.controls.target.x, y: objMain.controls.target.y, z: objMain.controls.target.z, t: Date.now() }, newT: { x: objMain.selectObj.obj.position.x, y: objMain.selectObj.obj.position.y, z: objMain.selectObj.obj.position.z, t: Date.now() + 3e3 } }, objMain.camaraAnimateData = e, null != objMain.selectObj.obj && (e = objMain.selectObj.obj.name, objMain.ws.send(JSON.stringify({ c: "LookForBuildings", selectObjName: e }))), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }) } switch (objMain.carState.car) { case "waitAtBaseStation": switch (objMain.Task.state) { case "collect": e("收集", "collectBtn", function () { var e; objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (e = objMain.selectObj.obj, objMain.ws.send(JSON.stringify({ c: "Collect", cType: "findWork", fastenpositionID: e.userData.collectPosition.Fp.FastenPositionID, collectIndex: e.userData.collectPosition.collectIndex })), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }), n(); break; case "attack": a(), n(); break; case "mile": case "business": case "volume": case "speed": e("寻宝", "promoteBtn", function () { objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (objMain.ws.send(JSON.stringify({ c: "Promote", pType: objMain.selectObj.type })), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }), n(); break; case "ability": e(1 == objMain.trade.countPerOperate ? "使用" : "用" + objMain.trade.countPerOperate + "枚", "useDiamondBtn", function () { "waitAtBaseStation" == objMain.carState.car && 0 < objMain.PromoteDiamondCount[objMain.selectObj.obj.userData.index] && objMain.ws.send(JSON.stringify({ c: "Ability", pType: objMain.selectObj.obj.userData.index, count: objMain.trade.countPerOperate })) }), e(1 == objMain.trade.countPerOperate ? "出售" : "卖" + objMain.trade.countPerOperate + "枚", "sellDiamondBtn", function () { "waitAtBaseStation" == objMain.carState.car && objMain.ws.send(JSON.stringify({ c: "SellDiamond", pType: objMain.selectObj.obj.userData.index, count: objMain.trade.countPerOperate })) }), e(1 == objMain.trade.countPerOperate ? "购买" : "买" + objMain.trade.countPerOperate + "枚", "buyDiamondBtn", function () { "waitAtBaseStation" == objMain.carState.car && objMain.ws.send(JSON.stringify({ c: "BuyDiamond", pType: objMain.selectObj.obj.userData.index, count: objMain.trade.countPerOperate })) }), e(1 == objMain.trade.countPerOperate ? "数量" : "量:" + objMain.trade.countPerOperate, "tradeDiamondCountBtn", function () { if ("waitAtBaseStation" == objMain.carState.car) { function e(e, a) { document.getElementById(e).children[0].innerText = a } switch (objMain.trade.countPerOperate) { case 1: objMain.trade.countPerOperate = 2; break; case 2: objMain.trade.countPerOperate = 5; break; case 5: objMain.trade.countPerOperate = 10; break; case 10: objMain.trade.countPerOperate = 20; break; case 20: objMain.trade.countPerOperate = 50; break; case 50: objMain.trade.countPerOperate = 1 }e("useDiamondBtn", 1 == objMain.trade.countPerOperate ? "使用" : "用" + objMain.trade.countPerOperate + "枚"), e("sellDiamondBtn", 1 == objMain.trade.countPerOperate ? "出售" : "卖" + objMain.trade.countPerOperate + "枚"), e("buyDiamondBtn", 1 == objMain.trade.countPerOperate ? "购买" : "买" + objMain.trade.countPerOperate + "枚"), e("tradeDiamondCountBtn", 1 == objMain.trade.countPerOperate ? "数量" : "量:" + objMain.trade.countPerOperate) } }); break; case "setReturn": e("招募", "findDriver", function () { "waitAtBaseStation" == objMain.carState.car && driverSys.draw(function (e) { objMain.ws.send(JSON.stringify({ c: "DriverSelect", driverIndex: e })) }) }), e("释玉", "takeapart", function () { "waitAtBaseStation" == objMain.carState.car && objMain.ws.send(JSON.stringify({ c: "TakeApart" })) }), n(); break; case "building": "OnLine" == objMain.state && (null != objMain.selectObj.obj && null != objMain.selectObj.obj.userData && "building" == objMain.selectObj.obj.userData.modelType ? i : n)() }break; case "waitOnRoad": switch (objMain.Task.state) { case "collect": e("收集", "collectBtn", function () { var e; objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (e = objMain.selectObj.obj, objMain.ws.send(JSON.stringify({ c: "Collect", cType: "findWork", fastenpositionID: e.userData.collectPosition.Fp.FastenPositionID, collectIndex: e.userData.collectPosition.collectIndex })), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }), n(); break; case "attack": a(), t(), n(); break; case "mile": case "business": case "volume": case "speed": e("寻宝", "promoteBtn", function () { objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (objMain.ws.send(JSON.stringify({ c: "Promote", pType: objMain.selectObj.type })), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }), n(); break; case "setReturn": 0 < objMain.driver.driverIndex && "devil" == objMain.driver.race && t(), n(); break; case "building": "LookForBuildings" == objMain.state ? e("取消", "cancelBuildingDetailF", function () { objMain.canSelect = !1, "waitAtBaseStation" != objMain.carState.car && "waitOnRoad" != objMain.carState.car || (objMain.ws.send(JSON.stringify({ c: "CancleLookForBuildings" })), objMain.selectObj.obj = null, objMain.selectObj.type = "") }) : "OnLine" == objMain.state && (null != objMain.selectObj.obj && objMain.selectObj.obj.userData && "building" == objMain.selectObj.obj.userData.modelType ? i : n)() }"OnLine" == objMain.state && e("回基地", "goBackBtn", function () { objMain.canSelect = !1, "waitOnRoad" == objMain.carState.car && (objMain.selectObj.obj, objMain.ws.send(JSON.stringify({ c: "SetCarReturn" })), objMain.selectObj.obj = null, objMain.selectObj.type = "", operatePanel.refresh()) }); break; case "selecting": e("路口", "selectDirectionBtn", function () { var e; "selecting" == objMain.carState.car && 0 < objMain.directionGroup.children.length && (e = objMain.directionGroup.children[0], e = { old: { x: objMain.controls.target.x, y: objMain.controls.target.y, z: objMain.controls.target.z, t: Date.now() }, newT: { x: e.position.x, y: e.position.y, z: e.position.z, t: Date.now() + 3e3 } }, objMain.camaraAnimateData = e, operatePanel.refresh()) }) } } }, ModelOperateF = { f: function (a, n) { var t = new THREE.LoadingManager; new THREE.MTLLoader(t).loadTextOnly(a.Mtl, "data:image/jpeg;base64," + a.Img, function (e) { e.preload(), new THREE.OBJLoader(t).setMaterials(e).loadTextOnly(a.Obj, function (e) { if (null == n.scale ? e.scale.set(.003, .003, .003) : e.scale.set(n.scale.x, n.scale.y, n.scale.z), null == n.rotateX || e.rotateX(n.rotateX), null != n.transparent) for (var a = 0; a < e.children.length; a++)if (e.children[a].isMesh) if (e.children[a].material.isMaterial) e.children[a].material.transparent = !0, e.children[a].material.opacity = n.transparent.opacity; else for (var t = 0; t < e.children[a].material.length; t++)e.children[a].material[t].transparent = !0, e.children[a].material[t].opacity = n.transparent.opacity; if (null != n.color) for (a = 0; a < e.children.length; a++)if (e.children[a].isMesh) for (t = 0; t < e.children[a].material.length; t++)e.children[a].material[t].color = new THREE.Color(n.color.r, n.color.g, n.color.b); null != n.rotate && (e.rotateX(n.rotate.x), e.rotateX(n.rotate.y), e.rotateX(n.rotate.z)), null != n.bind && n.bind(e) }, function () { }, function () { }) }) } }, stateSet = { speed: { add: function (e) { for (var a = 0; a < 2; a++) { var t = objMain.ModelInput.speed.children[0].clone(); t.name = "fire" + a.toString() + "_" + e, t.position.x = 77, t.position.z = 4 - 18 * a, t.rotateY(Math.PI / 2 * 3), t.scale.z = 2; var n = objMain.carGroup.getObjectByName("car_" + e); n && (n.getObjectByName(t.name) || n.add(t)) } }, Animate: function (e) { var a = objMain.carGroup.getObjectByName("car_" + e); if (a) for (var t = 0; t < 2; t++) { var n = "fire" + t.toString() + "_" + e, o = a.getObjectByName(n); o && (n = Date.now() % 500 / 500, o.position.x = 77 + 20.11 * n, o.scale.z = 2 + n) } }, clear: function (e) { var a = objMain.carGroup.getObjectByName("car_" + e); if (a) for (var t = 0; t < 2; t++) { var n = "fire" + t.toString() + "_" + e, n = a.getObjectByName(n); n && a.remove(n) } } }, attck: { add: function (e) { var a = objMain.ModelInput.attack.children[0].clone(); a.name = "fist_" + e, a.position.x = -0, a.position.y = -30, a.position.z = 0, a.rotateX(Math.PI / 2), a.rotateY(Math.PI), a.scale.set(5, 5, 5); e = objMain.carGroup.getObjectByName("car_" + e); e && (e.getObjectByName(a.name) || e.add(a)) }, Animate: function (e) { var a = objMain.carGroup.getObjectByName("car_" + e); a && (e = "fist_" + e, (a = a.getObjectByName(e)) && ((e = Date.now() % 500 / 500) < .3 ? e /= .3 : e = (1 - e) / .7, a.position.x = 5 * e - 40)) }, clear: function (e) { var a = objMain.carGroup.getObjectByName("car_" + e); a && (e = "fist_" + e, (e = a.getObjectByName(e)) && a.remove(e)) } }, defend: { add: function (e) { var a = objMain.playerGroup.getChildByName("flag_" + e); if (a) { var t = new THREE.Object3D; t.name = "defender_" + e, t.position.set(a.position.x, a.position.y, a.position.z); for (var n = 0; n < 3; n++) { var o = objMain.ModelInput.shield.children[0].clone(); o.name = "shield" + n.toString() + "_" + e, o.position.x = .8 * Math.cos(2 * n * Math.PI / 3), o.position.y = .5, o.position.z = .8 * Math.sin(2 * n * Math.PI / 3), o.scale.set(.003, .003, .003), o.rotateX(Math.PI / 2), o.rotateZ(-Math.PI / 2 + 2 * n * Math.PI / 3), t.add(o) } objMain.shieldGroup.getObjectByName(t.name) || objMain.shieldGroup.add(t) } }, Animate: function (e) { e = "defender_" + e, e = objMain.shieldGroup.getObjectByName(e); e && (e.rotation.y = (Math.sin(Date.now() % 2e3 / 2e3 * Math.PI * 2) + 1) * Math.PI) }, clear: function (e) { var e = "defender_" + e, a = objMain.shieldGroup.getObjectByName(e); if (a) { for (var t = a.children.length - 1; 0 <= t; t--)a.remove(a.children[t]); objMain.shieldGroup.remove(a) } } }, confusePrepare: { add: function (e, a) { var t = new THREE.Object3D; t.name = "confusePrepare_" + e, t.position.set(a.startX, a.startY, a.startZ); var n = objMain.ModelInput.confusePrepare.children[0].clone(); n.name = "confusePrepareChild_" + e, n.position.x = 0, n.position.y = 0, n.position.z = 0, n.scale.set(.05, .05, .05), n.rotateX(Math.PI / 2), t.add(n), t.userData.animateData = a, objMain.confusePrepareGroup.getObjectByName(t.name) || objMain.confusePrepareGroup.add(t) }, Animate: function (e) { var a, t, n = "confusePrepare_" + e, o = objMain.confusePrepareGroup.getObjectByName(n); o && (t = o.userData.animateData, a = (Date.now() - t.start) % 3e3 / 3e3, e = t.startX + a * (t.endX - t.startX), n = t.startY + a * (t.endY - t.startY), t = t.startZ + a * (t.endZ - t.startZ), o.position.set(e, n, t), o.children[0].position.set(.1 * Math.sin(20 * a), .06 * Math.sin(10 * a), .08 * Math.sin(15 * a)), o.children[0].rotation.set(1.7 * a % 1 * Math.PI * 2, 1.1 * a % 1 * Math.PI * 2, 1.3 * a % 1 * Math.PI * 2)) }, clear: function (e) { var e = "confusePrepare_" + e, a = objMain.confusePrepareGroup.getObjectByName(e); if (a) { for (var t = a.children.length - 1; 0 <= t; t--)a.remove(a.children[t]); objMain.confusePrepareGroup.remove(a) } } }, confuse: { add: function (e) { var a = objMain.ModelInput.confusePrepare.children[0].clone(); a.name = "confuse_" + e, a.position.y = 18, a.scale.set(5, 5, 5); e = objMain.carGroup.getObjectByName("car_" + e); e && (e.getObjectByName(a.name) || e.add(a)) }, Animate: function (e) { var a, t = objMain.carGroup.getObjectByName("car_" + e); t && (a = "confuse_" + e, (e = t.getObjectByName(a)) && (t = (Date.now() % 1500 - 750) / 750, a = Date.now() % 1e4 / 1e4, e.rotation.set(0, Math.abs(t * Math.PI) + 2 * a * Math.PI, 0, "XYZ"))) }, clear: function (e) { var a = objMain.carGroup.getObjectByName("car_" + e); a && (e = "confuse_" + e, (e = a.getObjectByName(e)) && a.remove(e)) } }, lostPrepare: { add: function (e, a) { var t = new THREE.Object3D; t.name = "lostPrepare_" + e, t.position.set(a.startX, a.startY, a.startZ); var n = objMain.ModelInput.lostPrepare.children[0].clone(); n.name = "lostPrepareChild_" + e, n.position.x = 0, n.position.y = 0, n.position.z = 0, n.scale.set(.015, .015, .015), n.rotateZ(Math.PI / 2), t.add(n), t.userData.animateData = a, objMain.lostPrepareGroup.getObjectByName(t.name) || objMain.lostPrepareGroup.add(t) }, Animate: function (e) { var a, t, n = "lostPrepare_" + e, o = objMain.lostPrepareGroup.getObjectByName(n); o && (t = o.userData.animateData, a = (Date.now() - t.start) % 3e3 / 3e3, e = t.startX + a * (t.endX - t.startX), n = t.startY + a * (t.endY - t.startY), t = t.startZ + a * (t.endZ - t.startZ), o.position.set(e, n, t), o.children[0].rotation.set(2 * a % 1 * Math.PI * 2, 0, Math.PI / 2)) }, clear: function (e) { var e = "lostPrepare_" + e, a = objMain.lostPrepareGroup.getObjectByName(e); if (a) { for (var t = a.children.length - 1; 0 <= t; t--)a.remove(a.children[t]); objMain.lostPrepareGroup.remove(a) } } }, lost: { add: function (e) { var a = objMain.ModelInput.lostPrepare.children[0].clone(); a.name = "lost_" + e, a.position.y = 35, a.scale.set(1, 1, 1); e = objMain.carGroup.getObjectByName("car_" + e); e && (e.getObjectByName(a.name) || e.add(a)) }, Animate: function (e) { var a = objMain.carGroup.getObjectByName("car_" + e); a && (e = "lost_" + e, (a = a.getObjectByName(e)) && (e = Date.now() % 2500 / 2500, a.rotation.set(0, 2 * e * Math.PI, 0, "XYZ"))) }, clear: function (e) { var a = objMain.carGroup.getObjectByName("car_" + e); a && (e = "lost_" + e, (e = a.getObjectByName(e)) && a.remove(e)) } }, ambusePrepare: { add: function (e, a) { var t = new THREE.Object3D; t.name = "ambusePrepare_" + e, t.position.set(a.startX, a.startY, a.startZ); var n = objMain.ModelInput.ambushPrepare.children[0].clone(); n.name = "ambusePrepareChild_" + e, n.position.x = 0, n.position.y = 0, n.position.z = 0, n.scale.set(.005, .005, .005), t.add(n), t.userData.animateData = a, objMain.ambushPrepareGroup.getObjectByName(t.name) || objMain.ambushPrepareGroup.add(t) }, Animate: function (e) { var a, t, n = "ambusePrepare_" + e, o = objMain.ambushPrepareGroup.getObjectByName(n); o && (t = o.userData.animateData, a = (Date.now() - t.start) % 3e3 / 3e3, e = t.startX + a * (t.endX - t.startX), n = t.startY + a * (t.endY - t.startY), t = t.startZ + a * (t.endZ - t.startZ), o.position.set(e, n, t)) }, clear: function (e) { var e = "ambusePrepare_" + e, a = objMain.ambushPrepareGroup.getObjectByName(e); if (a) { for (var t = a.children.length - 1; 0 <= t; t--)a.remove(a.children[t]); objMain.ambushPrepareGroup.remove(a) } } }, control: { clear: function (e) { stateSet.confusePrepare.clear(e), stateSet.lostPrepare.clear(e), stateSet.ambusePrepare.clear(e) } }, water: { add: function (e, a) { this.clear(a); e = objMain.playerGroup.getChildByName("flag_" + e); if (e) { for (var t = objMain.ModelInput.water.clone(), n = 0; n < t.children.length; n++)t.children[n].material.transparent = !0, t.children[n].material.opacity = .6; t.name = "water_" + a, t.position.set(e.position.x, e.position.y, e.position.z), t.scale.set(.15, .5, .15), t.userData = { startT: Date.now() }, objMain.waterGroup.add(t) } }, Animate: function (e) { var a = "water_" + e, e = objMain.waterGroup.getObjectByName(a); e && ((a = (Date.now() - e.userData.startT) / 1e4) < 1 ? (e.getObjectByName("shuilang").scale.set(1, 1 - a, 1), e.getObjectByName("shuizhu").scale.set(1 + Math.pow(10 * a, .66), 1, 1 + Math.pow(10 * a, .66))) : objMain.waterGroup.remove(e)) }, clear: function (e) { e = "water_" + e, e = objMain.waterGroup.getObjectByName(e); e && objMain.waterGroup.remove(e) }, mark: { material: new THREE.LineBasicMaterial({ color: 255 }), add: function (e) { const a = []; a.push(new THREE.Vector3(e[0], 0, -e[1])), a.push(new THREE.Vector3(e[2], 0, -e[3])), a.push(new THREE.Vector3(e[4], 0, -e[5])); e = (new THREE.BufferGeometry).setFromPoints(a), e = new THREE.Line(e, this.material); e.userData = { startT: Date.now() }, objMain.waterMarkGroup.add(e) }, Animate: function () { 500 < Date.now() % 1e3 ? (this.material.color.r = 0, this.material.color.g = 1, this.material.color.b = .45) : (this.material.color.r = .1, this.material.color.g = .45, this.material.color.b = 1); for (var e = objMain.waterMarkGroup, a = e.children.length - 1; 0 <= a; a--)2e4 < Date.now() - e.children[a].userData.startT && e.remove(e.children[a]) } } }, fire: { particleCount: 400, add: function (e, a) { this.clear(a); var t = new fire; t.install({ THREE: THREE }); var n = new t.Geometry(10, 35, this.particleCount), o = new t.Material({ color: 8388736 }), t = window.innerHeight; o.setPerspective(objMain.camera.fov, t); o = new THREE.Points(n, o), e = objMain.playerGroup.getChildByName("flag_" + e); e && (o.position.set(e.position.x, e.position.y, e.position.z), o.name = "fire_" + a, o.userData = { startT: Date.now() }, objMain.fireGroup.add(o)) }, Animate: function (e) { var a = "fire_" + e, t = objMain.fireGroup.getObjectByName(a); if (t) if (t.material.update(Date.now() % 2e3 / 2e3 * 20), (Date.now() - t.userData.startT) / 1e4 < 1) { e = objMain.carGroup.getObjectByName("car_" + e); if (e) { var n = e.position.x - t.position.x, o = e.position.z - t.position.z; for (let e = this.particleCount - this.particleCount / 4; e < this.particleCount; e++) { var i = (e - (this.particleCount - this.particleCount / 4)) / (this.particleCount / 4); t.geometry.attributes.position.array[3 * e + 0] = i * n, t.geometry.attributes.position.array[3 * e + 1] = -100 * (i * i - i), t.geometry.attributes.position.array[3 * e + 2] = i * o } t.geometry.attributes.position.needsUpdate = !0 } } else objMain.fireGroup.remove(t) }, clear: function (e) { e = "fire_" + e, e = objMain.fireGroup.getObjectByName(e); e && objMain.fireGroup.remove(e) }, mark: { material: new THREE.LineBasicMaterial({ color: 593680 }), add: function (e) { const a = []; for (var t = 0; t < e.length; t += 2)a.push(new THREE.Vector3(e[t], 0, -e[t + 1])); var n = (new THREE.BufferGeometry).setFromPoints(a), n = new THREE.Line(n, this.material); n.userData = { startT: Date.now() }, objMain.fireMarkGroup.add(n) }, Animate: function () { 500 < Date.now() % 1e3 ? (this.material.color.r = 2, this.material.color.g = .4) : (this.material.color.r = 1.2, this.material.color.g = 1.2), this.material.color.b = .3; for (var e = objMain.fireMarkGroup, a = e.children.length - 1; 0 <= a; a--)2e4 < Date.now() - e.children[a].userData.startT && e.remove(e.children[a]) } } }, lightning: { add: function (e, a) { this.clear(a); var t = { sourceOffset: new THREE.Vector3, destOffset: new THREE.Vector3, radius0: .07, radius1: .08, minRadius: .05, maxIterations: 7, isEternal: !0, timeScale: .7, propagationTimeFactor: .05, vanishingTimeFactor: .95, subrayPeriod: 3.5, subrayDutyCycle: .6, maxSubrayRecursion: 3, ramification: 7, recursionProbability: .6, roughness: .85, straightness: .8 }, n = new THREE.LightningStrike(t), t = new THREE.MeshBasicMaterial({ color: new THREE.Color(11599870) }); let o = new THREE.Mesh(n, t); o.name = "lightning_" + a; e = objMain.playerGroup.getObjectByName("flag_" + e); e && (o.position.set(e.position.x, e.position.y, e.position.z), o.userData = { startT: Date.now() }, objMain.lightningGroup.add(o)) }, Animate: function (e) { var a, t = "lightning_" + e, n = objMain.lightningGroup.getObjectByName(t); n && ((a = (Date.now() - n.userData.startT) / 1e4) < 1 ? (e = (t = objMain.carGroup.getObjectByName("car_" + e)).position.x - n.position.x, t = t.position.z - n.position.z, n.geometry.rayParameters.sourceOffset.copy(new THREE.Vector3(e, 10, t)), n.geometry.rayParameters.sourceOffset.y += 1, n.geometry.rayParameters.destOffset.copy(new THREE.Vector3(3.3 * Math.sin(a * Math.PI * 5), 0, Math.cos(a * Math.PI * 1.5))), --n.geometry.rayParameters.destOffset.y, n.geometry.update(Date.now() / 2e3)) : objMain.lightningGroup.remove(n)) }, clear: function (e) { e = "lightning_" + e, e = objMain.lightningGroup.getObjectByName(e); e && objMain.lightningGroup.remove(e) }, mark: { material: new THREE.LineBasicMaterial({ color: 11599870 }), add: function (e) { const a = []; a.push(new THREE.Vector3(e[0], 0, -e[1])), a.push(new THREE.Vector3(e[2], 0, -e[3])), a.push(new THREE.Vector3(e[4], 0, -e[5])), a.push(new THREE.Vector3(e[6], 0, -e[7])), a.push(new THREE.Vector3(e[0], 0, -e[1])); e = (new THREE.BufferGeometry).setFromPoints(a), e = new THREE.Line(e, this.material); e.userData = { startT: Date.now() }, objMain.lightningMarkGroup.add(e) }, Animate: function () { 500 < Date.now() % 1e3 ? (this.material.color.r = .68, this.material.color.g = .05859375, this.material.color.b = .9921875) : (this.material.color.g = 2, this.material.color.r = 2, this.material.color.b = 1); for (var e = objMain.lightningMarkGroup, a = e.children.length - 1; 0 <= a; a--)2e4 < Date.now() - e.children[a].userData.startT && e.remove(e.children[a]) } } }, diamond: { add: function (e, a) { var t; "" == a ? (this.clear(e, "mile"), this.clear(e, "business"), this.clear(e, "volume"), this.clear(e, "speed")) : objMain.promoteDiamond.getObjectByName("diamond_" + a) && ((t = objMain.promoteDiamond.getObjectByName("diamond_" + a).clone()).name = "car_" + a + "_" + e, t.position.set(9, 35, 0), t.scale.set(10, 11, 10), (e = objMain.carGroup.getObjectByName("car_" + e)) && (e.getObjectByName(t.name) || e.add(t))) }, clear: function (e, a) { var t = objMain.carGroup.getObjectByName("car_" + e); t && (e = "car_" + a + "_" + e, (e = t.getObjectByName(e)) && t.remove(e)) } } }, DirectionOperator = { data: null, show: function (e) { DirectionOperator.data = e, objMain.mainF.removeF.clearGroup(objMain.buildingSelectionGroup), objMain.mainF.removeF.clearGroup(objMain.directionGroup); e = objMain.ModelInput.direction.clone(); e.rotateX(-Math.PI / 2), e.scale.set(.4, .4, .4), e.position.set(DirectionOperator.data.positionX, DirectionOperator.data.positionZ * objMain.heightAmplify - .1, -DirectionOperator.data.positionY), objMain.directionGroup.add(e); for (var a = 0; a < DirectionOperator.data.direction.length; a++) { var t = objMain.ModelInput.directionArrow.obj.clone(); t.scale.set(.03, .03, .03), t.position.set(DirectionOperator.data.positionX, DirectionOperator.data.positionZ * objMain.heightAmplify - .1, -DirectionOperator.data.positionY), t.rotation.y = DirectionOperator.data.direction[a], objMain.directionGroup.add(t) } } }, BuildingModelObj = { f: function (t) { var e, a; t.existed ? (e = t.amodel, BuildingModelObj.copy(e, t)) : null == objMain.buildingGroup.getObjectByName(t.modelID) && (a = new THREE.LoadingManager, new THREE.MTLLoader(a).loadTextOnly(t.mtlText, "data:image/jpeg;base64," + t.imageBase64, function (e) { e.preload(), new THREE.OBJLoader(a).setMaterials(e).loadTextOnly(t.objText, function (e) { var a = t.amodel; (objMain.buildingModel[a] = e).userData.modelType = t.modelType, BuildingModelObj.copy(a, t) }, function () { }, function () { }) })) }, copy: function (e, a) { null == objMain.buildingModel[e] || null == objMain.buildingGroup.getObjectByName(a.modelID) && ((e = objMain.buildingModel[e].clone()).name = a.modelID, e.position.set(a.x, a.y * objMain.heightAmplify, a.z), e.rotation.set(0, a.rotatey, 0, "XYZ"), e.userData.modelType = a.modelType, objMain.buildingGroup.add(e), "LookForBuildings" == objMain.state && objMain.mainF.lookAtPosition2()) }, respon: function (e) { e = e.amodel; null == objMain.buildingModel[e] ? objMain.ws.send(JSON.stringify({ c: "ModelNotExited" })) : objMain.ws.send(JSON.stringify({ c: "ModelExited" })) } }, SetBustPage = function () { window.cancelAnimationFrame(objMain.animateObj), document.body.innerHTML = ""; var e = document.createElement("img"); e.src = "Pic/gameOver.jpg", e.style.position = "absolute", e.style.top = "50%", e.style.left = "50%", e.style.width = "calc(80%)", e.style.height = "auto", e.style.maxWidth = "calc(80%)", e.style.maxHeight = "calc(80%)", e.style.minWidth = "calc(20%)", e.style.minWidth = "calc(20%)", e.style.transform = "translate(-50%, -50%)", document.body.appendChild(e) }, drawGoodsSelection = { f: function (e) { objMain.mainF.removeF.clearGroup(objMain.buildingSelectionGroup); for (var a = 0; a < e.selections.length; a++) { var t = []; t.push(new THREE.Vector3(e.x, e.y * objMain.heightAmplify, e.z)), t.push(new THREE.Vector3(e.positions[3 * a], e.positions[3 * a + 1] * objMain.heightAmplify, e.positions[3 * a + 2])); t = (new THREE.BufferGeometry).setFromPoints(t), t = new THREE.Line(t, drawGoodsSelection.material); objMain.buildingSelectionGroup.add(t) } }, material: new THREE.LineBasicMaterial({ color: 3407616 }) }, DiamondModel = { black: null, blue: null, green: null, red: null, initialize: function (a) { for (var e = ["black", "blue", "green", "red"], t = 0; t < 4; t++) { var n = t, o = e[n], i = new THREE.LoadingManager; new THREE.MTLLoader(i).loadTextOnly(a.mtlText, "data:image/jpeg;base64," + a.imageBase64s[n], function (e) { e.preload(), new THREE.OBJLoader(i).setMaterials(e).loadTextOnly(a.objText, function (e) { DiamondModel[o] = e }, function () { }, function () { }) }) } } }, sceneYUpdate = function (e) { var a = (new THREE.Vector3).subVectors(objMain.controls.target, objMain.camera.position); if (0 < a.length()) { a.setLength(1); var t = new THREE.Vector3(0, 1, 0), n = (new THREE.Vector3).crossVectors(a, t); if (0 < n.length()) { n.setLength(1); var o = (t = (new THREE.Vector3).crossVectors(n, a)).applyAxisAngle(n, -4.13 / 180 * Math.PI), a = o.x, t = o.y, n = o.z, o = -a * objMain.camera.position.x - t * objMain.camera.position.y - n * objMain.camera.position.z; if (1e-4 < Math.abs(t)) { t = (-o - a * objMain.controls.target.x - n * objMain.controls.target.z) / t; return 25 < t ? t = 25 : t < -25 && (t = -25), objMain.scene.position.y = t - e, t } } } }, OperateHelp = { isOn: !0, f: function () { this.isOn && "OnLine" == objMain.state && (null != objMain.directionGroup && objMain.directionGroup.visible && this.probability.direction < Math.random() && ($.notify(AMsg.directionNotify, { autoHide: !0, className: "info", autoHideDelay: 2e4 }), this.probability.direction += .015), objMain.carState.car && "waitAtBaseStation" == objMain.carState.car && this.probability.waitAtBaseStation < Math.random() && ($.notify(AMsg.waitAtStationNotify, { autoHide: !0, className: "info", autoHideDelay: 2e4, position: "left" }), this.probability.waitAtBaseStation += .015)) }, probability: { direction: 0, waitAtBaseStation: 0 } }; function Complex(e, a) { if (isNaN(e) || isNaN(a)) throw new TypeError("Complex params require Number"); this.r = e, this.i = a } setInterval("OperateHelp.f();", 12e3), Complex.prototype.add = function (e) { return new Complex(this.r + e.r, this.i + e.i) }, Complex.prototype.neg = function () { return new Complex(-this.r, -this.i) }, Complex.prototype.multiply = function (e) { return this.r === e.r && this.i + e.i === 0 ? this.r * this.r + this.i * this.i : new Complex(this.r * e.r - this.i * e.i, this.r * e.i + this.i * e.r) }, Complex.prototype.divide = function (e) { var a = this.r, t = this.i, n = e.r, e = e.i; return new Complex((a * n + t * e) / (n * n + e * e), (t * n - a * e) / (n * n + e * e)) }, Complex.prototype.mo = function () { return Math.sqrt(this.r * this.r + this.i * this.i) }, Complex.prototype.toAngle = function () { if (1e-6 < this.r) return (Math.atan(this.i / this.r) + 4 * Math.PI) % (2 * Math.PI); if (this.r < -1e-6) return (Math.atan(this.i / this.r) + 3 * Math.PI) % (2 * Math.PI); if (0 < this.i) return Math.PI / 2; if (this.i < 0) return 3 * Math.PI / 2; throw "this Complex can not change to angle" }, Complex.prototype.toOne = function () { var e = this.mo(); this.r /= e, this.i /= e }, Complex.prototype.isZero = function () { return this.mo() < 1e-4 }, Complex.prototype.toString = function () { return "{" + this.r + "," + this.i + "}" }, Complex.prototype.equal = function (e) { return null !== e && e.constructor === Complex && this.r === e.r && this.i === e.i }, Complex.ZERO = new Complex(0, 0), Complex.ONE = new Complex(1, 0), Complex.I = new Complex(0, 1), Complex.parse = function (a) { try { var e = Complex.parseRegExp.exec(a); return new Complex(parseFloat(e[1]), parseFloat(e[2])) } catch (e) { throw new TypeError("Can't parse '" + a + "'to a complex") } }, Complex.parseRegExp = /^\{([\d\s]+[^,]*),([\d\s]+[^}]*)\}$/, window.c = Complex;