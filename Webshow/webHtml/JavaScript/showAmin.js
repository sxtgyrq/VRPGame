var camera, controls, scene, renderer, labelRenderer, scene1, scene2, axesHelper, mesh, mapGroup, boundryGroup, peibianGroup, tongxin5GMapGroup, regionBlockGroup, lineGroup, lineLabelGroup, biandiansuoGroup, buildingsGroups, measureLengthGroup, measureAreaGroup, guangouGroup, chaoliufenxiGroup, chaoliufenxiGroup2, chaoliufenxiGroup3, chaoliufenxiGroup4, chaoliufenxiGroup5, songdianquGroup, runFromNginx = !1, aa = function () { return "showA Page:hello world!" }, setMap = function (e) { "e" == e ? (mercatoCenter.zoom = -10, constMapt = "e", updateMap()) : "m" == e ? (mercatoCenter.zoom = -10, constMapt = "m", updateMap()) : "r" == e && (mercatoCenter.zoom = -10, constMapt = "r", updateMap()) }, x_PI = 52.35987755982988, centerPosition = { lon: 112.573463, lat: 37.891474 }, mercatoCenter = { x: 0, zValue: 0, zoom: 0 }; !1 === WEBGL.isWebGLAvailable() && document.body.appendChild(WEBGL.getWebGLErrorMessage()); var light1, light2, light3, light4, raycaster, mapMesh, ctx, mapCanvas, chaoliufenxiGroupCount = 10, chaoliuFenxiData = [], mapGroupData = {}, constMapt = "e", clickState = "objClick", measureLengthObj = { start: { x: 0, y: 0 }, end: { x: 0, y: 0 }, state: 0, getAngleF: function (e, a, r, i) { var o = Math.sqrt((r - e) * (r - e) + (i - a) * (i - a)); return o > 0 ? r - e > 0 ? Math.asin((i - a) / o) : Math.PI - Math.asin((i - a) / o) : 0 }, result: 0, measureLineDiv: null, measureLineDivLabel: null }, measureAreaObj = { points: [], measureAreaDiv: null, measureAreaDivLabel: null }; function init() { (scene = new THREE.Scene).background = new THREE.Color(8166868), scene.fog = new THREE.FogExp2(8166868, .002); var e = new THREE.CubeTextureLoader; e.setPath("Pic/"); var a = e.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"]); scene.background = a, (renderer = new THREE.WebGLRenderer({ alpha: !0 })).setClearColor(0, 0), renderer.setPixelRatio(window.devicePixelRatio), renderer.setSize(window.innerWidth, window.innerHeight), renderer.domElement.className = "renderDom", document.getElementById("mainC").appendChild(renderer.domElement), (labelRenderer = new THREE.CSS2DRenderer).setSize(window.innerWidth, window.innerHeight), labelRenderer.domElement.className = "labelRenderer", document.getElementById("mainC").appendChild(labelRenderer.domElement), (camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1e-4, 1e3)).position.set(4e3, 2e3, 0), camera.position.set(MercatorGetXbyLongitude(centerPosition.lon), 0, -MercatorGetYbyLatitude(centerPosition.lat)), (controls = new THREE.OrbitControls(camera, labelRenderer.domElement)).center.set(MercatorGetXbyLongitude(centerPosition.lon), 0, -MercatorGetYbyLatitude(centerPosition.lat)), (axesHelper = new THREE.AxesHelper(265)).position.set(MercatorGetXbyLongitude(centerPosition.lon), 0, -MercatorGetYbyLatitude(centerPosition.lat)), controls.enableDamping = !0, controls.dampingFactor = .25, controls.screenSpacePanning = !1, controls.minDistance = 6, controls.maxDistance = 96, controls.maxPolarAngle = Math.PI / 2 - Math.PI / 6, controls.minPolarAngle = 0; camera.position.set(MercatorGetXbyLongitude(centerPosition.lon), 50 * Math.sin(.4), 50 * Math.cos(.4) - MercatorGetYbyLatitude(centerPosition.lat)), mapGroup = new THREE.Group, scene.add(mapGroup), boundryGroup = new THREE.Group, scene.add(boundryGroup), peibianGroup = new THREE.Group, scene.add(peibianGroup), tongxin5GMapGroup = new THREE.Group, scene.add(tongxin5GMapGroup), regionBlockGroup = new THREE.Group, scene.add(regionBlockGroup), lineGroup = new THREE.Group, scene.add(lineGroup), lineLabelGroup = new THREE.Group, scene.add(lineLabelGroup), biandiansuoGroup = new THREE.Group, scene.add(biandiansuoGroup), buildingsGroups = new THREE.Group, scene.add(buildingsGroups), measureLengthGroup = new THREE.Group, scene.add(measureLengthGroup), measureAreaGroup = new THREE.Group, scene.add(measureAreaGroup), guangouGroup = new THREE.Group, scene.add(guangouGroup), chaoliufenxiGroup = []; for (var r = 0; r < chaoliufenxiGroupCount; r++) { var i = new THREE.Group; chaoliufenxiGroup.push(i), chaoliuFenxiData.push([]), scene.add(i) } songdianquGroup = new THREE.Group, scene.add(songdianquGroup); var o = new THREE.Geometry; o.vertices.push(new THREE.Vector3(0, .01, 0)), o.vertices.push(new THREE.Vector3(1, .01, 0)); var n = new THREE.LineBasicMaterial({ color: 16777215, linewidth: 10, side: THREE.DoubleSide }), t = new THREE.Line(o, n); measureLengthGroup.add(t), measureLengthObj.measureLineDiv = document.createElement("div"), measureLengthObj.measureLineDiv.className = "label", measureLengthObj.measureLineDiv.textContent = "Earth", measureLengthObj.measureLineDiv.style.marginTop = "-1em", measureLengthObj.measureLineDivLabel = new THREE.CSS2DObject(measureLengthObj.measureLineDiv), measureLengthObj.measureLineDivLabel.position.set(0, 0, 0), measureLengthGroup.add(measureLengthObj.measureLineDivLabel), measureAreaObj.measureAreaDiv = document.createElement("div"), measureAreaObj.measureAreaDiv.className = "label", measureAreaObj.measureAreaDiv.textContent = "Earth", measureAreaObj.measureAreaDiv.style.marginTop = "-1em", measureAreaObj.measureAreaDivLabel = new THREE.CSS2DObject(measureAreaObj.measureAreaDiv), measureAreaObj.measureAreaDivLabel.position.set(0, 0, 0), measureAreaGroup.add(measureAreaObj.measureAreaDivLabel); for (new THREE.CylinderBufferGeometry(0, 10, 30, 4, 1), new THREE.MeshPhongMaterial({ color: 16777215, flatShading: !0 }), r = 0; r < 500; r++); (light1 = new THREE.PointLight(16777215)).position.set(0, 9e4, 0), light1.intensity = .7, scene.add(light1), (light2 = new THREE.PointLight(16777215)).position.set(0, 9e4, -18e4), light2.intensity = .7, scene.add(light2), (light3 = new THREE.PointLight(16777215)).position.set(18e4, 9e4, -18e4), light3.intensity = .7, scene.add(light3), (light4 = new THREE.PointLight(16777215)).position.set(18e4, 9e4, 18e4), light4.intensity = .7, scene.add(light4), (raycaster = new THREE.Raycaster).linePrecision = 10, mouse = new THREE.Vector2, document.addEventListener("click", onDocumentClick), document.addEventListener("mousemove", onDocumentMouseMove, !1), window.addEventListener("resize", onWindowResize, !1), mapGroup.renderOrder = 0, boundryGroup.renderOrder = 9, lineGroup.renderOrder = 9, biandiansuoGroup.renderOrder = 9, peibianGroup.renderOrder = 9, tongxin5GMapGroup.renderOrder = 9, regionBlockGroup.renderOrder = 9, buildingsGroups.renderer = 10 } function onDocumentRightClick(e) { if ("areaMeasure" == clickState && (mouse.x = e.clientX / window.innerWidth * 2 - 1, mouse.y = -e.clientY / window.innerHeight * 2 + 1, raycaster.setFromCamera(mouse, camera), Math.abs(raycaster.ray.direction.y) > 1e-7)) { for (var a = -raycaster.ray.origin.y / raycaster.ray.direction.y, r = { x: raycaster.ray.origin.x + a * raycaster.ray.direction.x, z: raycaster.ray.origin.z + a * raycaster.ray.direction.z }, i = 1e8, o = -1, n = 0; n < measureAreaObj.points.length; n++) { var t = Math.sqrt((r.x - measureAreaObj.points[n].x) * (r.x - measureAreaObj.points[n].x) + (r.z - measureAreaObj.points[n].z) * (r.z - measureAreaObj.points[n].z)); t < i && (i = t, o = n) } o >= 0 && measureAreaObj.points.splice(o, 1), drawMeasuredArea() } } function onDocumentClick(e) { if ("objClick" == clickState) { mouse.x = e.clientX / window.innerWidth * 2 - 1, mouse.y = -e.clientY / window.innerHeight * 2 + 1, raycaster.setFromCamera(mouse, camera); var a = 1e8, r = null, i = ""; if (peibianGroup.visible) if ((t = raycaster.intersectObjects(peibianGroup.children)).length > 0) for (var o = 0; o < t.length; o++) t[o].distance < a && (r = t[o].object, i = "peibian", a = t[o].distance); if (tongxin5GMapGroup.visible) if ((t = raycaster.intersectObjects(tongxin5GMapGroup.children)).length > 0) for (o = 0; o < t.length; o++) t[o].distance < a && (r = t[o].object, i = "tongxin5G", a = t[o].distance); if (regionBlockGroup.visible) if ((t = raycaster.intersectObjects(regionBlockGroup.children)).length > 0) for (o = 0; o < t.length; o++) t[o].distance < a && (r = t[o].object, i = "regionBlock", a = t[o].distance); if (lineGroup.visible) { var n = []; for (o = 0; o < lineGroup.children.length; o++) "Line" == lineGroup.children[o].type && n.push(lineGroup.children[o]); var t; if ((t = raycaster.intersectObjects(n)).length > 0) for (o = 0; o < t.length; o++) t[o].distance < a && (r = t[o].object, i = "line", a = t[o].distance) } if (biandiansuoGroup.visible) if ((t = raycaster.intersectObjects(biandiansuoGroup.children)).length > 0) for (o = 0; o < t.length; o++) t[o].distance < a && (r = t[o].object, i = "line", a = t[o].distance); if (null != r) { var s = JSON.stringify({ command: "showInformation", selectType: i, Tag: r.Tag }); top.postMessage(s, "*"), console.log("iframe外发送信息", s) } } else if ("lengthMeasure" == clickState) { if (mouse.x = e.clientX / window.innerWidth * 2 - 1, mouse.y = -e.clientY / window.innerHeight * 2 + 1, raycaster.setFromCamera(mouse, camera), Math.abs(raycaster.ray.direction.y) > 1e-7) { var u = -raycaster.ray.origin.y / raycaster.ray.direction.y, l = { x: raycaster.ray.origin.x + u * raycaster.ray.direction.x, z: raycaster.ray.origin.z + u * raycaster.ray.direction.z }; 0 == measureLengthObj.state ? (measureLengthObj.start.x = l.x, measureLengthObj.start.y = -l.z, measureLengthObj.end.x = l.x + .001, measureLengthObj.end.y = -l.z - .001, measureLengthObj.state = 1) : 1 == measureLengthObj.state && (Math.abs(l.x - measureLengthObj.end.x) > .002 && (measureLengthObj.end.x = l.x), Math.abs(measureLengthObj.end.y + l.z) > .002 && (measureLengthObj.end.y = -l.z), measureLengthObj.state = 2) } } else if ("areaMeasure" == clickState && (randomV = 2 * Math.random() + .8, mouse.x = e.clientX / window.innerWidth * 2 - 1, mouse.y = -e.clientY / window.innerHeight * 2 + 1, raycaster.setFromCamera(mouse, camera), Math.abs(raycaster.ray.direction.y) > 1e-7)) { u = -raycaster.ray.origin.y / raycaster.ray.direction.y, l = { x: raycaster.ray.origin.x + u * raycaster.ray.direction.x, z: raycaster.ray.origin.z + u * raycaster.ray.direction.z }; measureAreaObj.points.push(l), drawMeasuredArea() } } var mouse = new THREE.Vector2; function onDocumentMouseMove(e) { if ("lengthMeasure" == clickState && (mouse.x = e.clientX / window.innerWidth * 2 - 1, mouse.y = -e.clientY / window.innerHeight * 2 + 1, raycaster.setFromCamera(mouse, camera), Math.abs(raycaster.ray.direction.y) > 1e-7)) { var a = -raycaster.ray.origin.y / raycaster.ray.direction.y, r = { x: raycaster.ray.origin.x + a * raycaster.ray.direction.x, z: raycaster.ray.origin.z + a * raycaster.ray.direction.z }; 0 == measureLengthObj.state ? (measureLengthObj.start.x = r.x, measureLengthObj.start.y = -r.z, measureLengthObj.end.x = r.x, measureLengthObj.end.y = -r.z) : 1 == measureLengthObj.state && (measureLengthObj.end.x = r.x, measureLengthObj.end.y = -r.z) } } var randomV = 2 * Math.random() + .8, updateLineMeasure = function () { if ("lengthMeasure" == clickState) { if (1 == measureLengthObj.state || 2 == measureLengthObj.state) { measureLengthGroup.children[0].position.set(measureLengthObj.start.x, .01, -measureLengthObj.start.y); var e = Math.sqrt((measureLengthObj.start.x - measureLengthObj.end.x) * (measureLengthObj.start.x - measureLengthObj.end.x) + (measureLengthObj.start.y - measureLengthObj.end.y) * (measureLengthObj.start.y - measureLengthObj.end.y)); if (measureLengthGroup.children[0].scale.set(e, e, e), e > 0) { measureLengthObj.start.y, measureLengthObj.end.y; var a = measureLengthObj.getAngleF(measureLengthObj.start.x, measureLengthObj.start.y, measureLengthObj.end.x, measureLengthObj.end.y); measureLengthGroup.children[0].rotation.set(0, a, 0) } measureLengthObj.result = getLengthOfTwoPoint(getBaiduPositionLon(measureLengthObj.start.x), getBaiduPositionLat(measureLengthObj.start.y), getBaiduPositionLon(measureLengthObj.end.x), getBaiduPositionLat(measureLengthObj.end.y)), measureLengthObj.measureLineDivLabel.position.set((measureLengthObj.start.x + measureLengthObj.end.x) / 2, .1, -(measureLengthObj.start.y + measureLengthObj.end.y) / 2); var r = ""; r = measureLengthObj.result >= 1e3 ? 10 * Math.round(measureLengthObj.result / 10) / 1e3 + "km" : Math.round(measureLengthObj.result) + "m", measureLengthObj.measureLineDiv.textContent = r } } else if ("areaMeasure" == clickState) { for (var i = -1e6, o = 1e6, n = -1e6, t = 1e6, s = 0, u = 0, l = 0; l < measureAreaObj.points.length; l++) { measureAreaObj.points[l].x > i && (i = measureAreaObj.points[l].x), measureAreaObj.points[l].x < o && (o = measureAreaObj.points[l].x), measureAreaObj.points[l].z > n && (n = measureAreaObj.points[l].z), measureAreaObj.points[l].z < t && (t = measureAreaObj.points[l].z); var c = measureAreaObj.points[(l - 1 + measureAreaObj.points.length) % measureAreaObj.points.length], d = measureAreaObj.points[l]; s += c.x * d.z - c.z * d.x, u += getLengthOfTwoPoint(getBaiduPositionLon(c.x), getBaiduPositionLat(-c.z), getBaiduPositionLon(d.x), getBaiduPositionLat(-d.z)) } if (measureAreaObj.points.length > 1) { s /= 2; var g = getLengthOfTwoPoint(getBaiduPositionLon(o), getBaiduPositionLat((-t - n) / 2), getBaiduPositionLon(i), getBaiduPositionLat((-t - n) / 2)), p = getLengthOfTwoPoint(getBaiduPositionLon((o + i) / 2), getBaiduPositionLat(-t), getBaiduPositionLon((o + i) / 2), getBaiduPositionLat(-n)), h = (getLengthOfTwoPoint(getBaiduPositionLon(o), getBaiduPositionLat(-t), getBaiduPositionLon(i), getBaiduPositionLat(-n)), Math.abs((i - o) * (n - t))); if (h > 1e-5) { s = s / h * (g * p); var m = u > 1e3 ? Math.round(u / 10) / 100 + "千米" : Math.round(u) + "米", b = Math.abs(Math.round(s / 1e3) / 10) + "公顷"; measureAreaObj.measureAreaDiv.textContent = "周长：" + m + ",面积：" + b + ",负荷密度：" + Math.round(u / 100 * randomV, 2) + "兆瓦/平方公里" } else measureAreaObj.measureAreaDiv.textContent = " " } else measureAreaObj.measureAreaDiv.textContent = " "; measureAreaObj.measureAreaDivLabel.position.set((o + i) / 2, .1, (t + n) / 2) } }; function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight, camera.updateProjectionMatrix(), renderer.setSize(window.innerWidth, window.innerHeight), labelRenderer.setSize(window.innerWidth, window.innerHeight) } var doC = !0; function animate() { doC && (requestAnimationFrame(animate), controls.update(), updatePlaneLineScale(), updateMap(), updateScale(), updateLineMeasure(), animateChaoliuFenxi(), render(), labelRenderer.render(scene, camera)) } function render() { renderer.clear(), renderer.render(scene, camera) } var updateMapContinue = !0, timeRocord = 0, loadMap = function () { (new THREE.TextureLoader).load("Pic/eall19.jpg", function (e) { var a = new THREE.MeshLambertMaterial({ map: e }), r = new THREE.PlaneGeometry(91, 80, 1, 1); (mesh = new THREE.Mesh(r, a)).position.set(97901.5, 0, -35454), mesh.name = "eall19", mapGroup.add(mesh) }, void 0, function (e) { console.error("An error happened.") }) }, namesShouldShow = []; function updateMap() { if (Math.abs(timeRocord - Date.now()) >= 0 && (timeRocord = Date.now(), updateMapContinue)) { var e = Math.sqrt((camera.position.x - controls.target.x) * (camera.position.x - controls.target.x) + (camera.position.y - controls.target.y) * (camera.position.y - controls.target.y) + (camera.position.z - controls.target.z) * (camera.position.z - controls.target.z)), a = Math.round(22 - Math.log2(e)); a > 19 ? a = 19 : a < 10 && (a = 10), camera.near = e, camera.far = 2 * e; var r, i = controls.target.x / Math.pow(2, 19 - a), o = controls.target.z / Math.pow(2, 19 - a); if (lineGroup.scale.set(1, e / 50, 1), biandiansuoGroup.scale.set(1, e / 50, 1), (mercatoCenter.zoom - a) * (mercatoCenter.zoom - a) + (mercatoCenter.zValue - o) * (mercatoCenter.zValue - o) + (mercatoCenter.x - i) * (mercatoCenter.x - i) > 1) { mercatoCenter.x = i, mercatoCenter.zValue = o, mercatoCenter.zoom = a; var n = [], t = o, s = a; r = [], i = Math.round(Math.floor(i)), t = -Math.round(Math.floor(t)); for (var u = i - 7; u < i + 7; u++) for (var l = t - 7; l < t + 7; l++) n.push({ x: u, y: l, z: s, t: constMapt }), r.push(constMapt + "_" + u + "_" + l + "_" + s); for (var c = function (e, a) { if ("no" == e) return !1; var r; (r = a ? JSON.parse(e) : e, mapGroup.getObjectByName(r.n)) || ((new THREE.TextureLoader).load(r.img, function (e) { var a = new THREE.MeshLambertMaterial({ map: e }); a.renderOrder = 0; var i = new THREE.PlaneGeometry(1, 1); (mesh = new THREE.Mesh(i, a)).position.set((r.x + .5) * Math.pow(2, 19 - r.z), 0, 0 - (r.y + .5) * Math.pow(2, 19 - r.z)), mesh.rotateX(-Math.PI / 2), mesh.scale.set(Math.pow(2, 19 - r.z), Math.pow(2, 19 - r.z), Math.pow(2, 19 - r.z)), mesh.name = r.n, mesh.renderOrder = 0, mesh.visible = r.exit, mapGroup.getObjectByName(r.n) || mapGroup.add(mesh) }, void 0, function (e) { console.error("An error happened.") }), a && (mapGroupData[r.n] || (mapGroupData[r.n] = r))); return !0 }, u = 0; u < n.length; u++) { var d = n[u].t + "_" + n[u].x + "_" + n[u].y + "_" + n[u].z, g = n[u].x, p = n[u].y, o = n[u].z, h = n[u].t; mapGroupData[d] ? c(mapGroupData[d], !1) : runFromNginx ? $.get("MapPathText/" + n[u].t + n[u].x + "_" + n[u].y + "_" + n[u].z + ".txt", n[u], function (e, a) { c(e, !0) || (mapGroupData[d] = JSON.stringify({ img: "data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAeAB4AAD/4QBaRXhpZgAATU0AKgAAAAgABQMBAAUAAAABAAAASgMDAAEAAAABAAAAAFEQAAEAAAABAQAAAFERAAQAAAABAAASdFESAAQAAAABAAASdAAAAAAAAYagAACxj//bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APf6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP//Z", x: g, y: p, z: o, t: h, n: d, exit: !1 })) }) : $.get("DAL/MapImage.ashx", n[u], function (e, a) { c(e, !0) }) } for (var u = mapGroup.children.length - 1; u >= 0; u--) r.indexOf(mapGroup.children[u].name) < 0 && setTimeout(function (e) { r.indexOf(e) < 0 && mapGroup.remove(mapGroup.getObjectByName(e)) }, 500, mapGroup.children[u].name); a >= 16 ? updateLabelOfLine() : clearLabelOfLine() } } } var testUpdateMap = function () { (new THREE.TextureLoader).load("Pic/e10_3_6.jpg", function (e) { var a = Number.parseInt(prompt("输入", 0)); e.repeat.set(1, 1), mapMesh.material[a] = new THREE.MeshBasicMaterial({ map: e }) }) }; function test() { $.get("http://localhost:2023/DAL/MapImage.ashx?x=10&y=3&z=6", function (e, a) { alert("Data: " + e + "nStatus: " + a) }) } function receiveMessage(e) { var a = JSON.parse(e.data); switch (a.command) { case "setMap": setMap(a.t); break; case "drawBoundry": drawBoundry(a.t); break; case "drawPeibian": drawPeibian(a.t); break; case "drawTongxin5G": drawTongxin5G(a.t); break; case "drawRegionBlock": drawRegionBlock(a.t); break; case "drawLine": drawLine(a.t); break; case "drawBiandiansuo": drawBiandiansuo(a.t); break; case "drawBuildings": drawBuildings(a.t); break; case "drawGuangou": drawLine2(a.t); break; case "drawChaoliufenxi": drawChaoliufenxi(a.t); break; case "drawSongdianquyu": drawSongdianquyu(a.t); break; case "search": switch (a.t) { case "peibian": var r = a.keyWords; searchPeibian(r); break; case "tongxin5G": r = a.keyWords; searchTongxin5G(r); break; case "regionBlock": r = a.keyWords; searchRegionBlock(r); break; case "line": r = a.keyWords; searchLineByIndex(r); break; case "lineName": r = a.keyWords; searchLineByName(r); break; case "biandiansuo": r = a.keyWords; searchBiandiansuo(r); break; case "buildings": r = a.keyWords; searchBuildings(r); break; default: throw "没法处理：" + e.data } return; case "measureLine": begainMeasureLength(); break; case "measureArea": begainMeasureArea(); break; case "measureCancle": measureCancle() } } function measureCancle() { clickState = "objClick", measureLengthGroup.children[0].position.set(0, .01, 0); measureLengthGroup.children[0].scale.set(1, 1, 1), measureLengthGroup.children[0].rotation.set(0, 0, 0), measureLengthObj.result = 0, measureLengthObj.measureLineDivLabel.position.set(0, .1, 0), measureLengthObj.measureLineDiv.textContent = ""; for (var e = measureAreaGroup.children.length - 1; e >= 1; e--) measureAreaGroup.remove(measureAreaGroup.children[e]); measureAreaObj.points = [], measureAreaObj.measureAreaDiv.textContent = " ", measureAreaObj.measureAreaDivLabel.position.set(0, .1, 0) } function begainMeasureLength() { clickState = "lengthMeasure", measureLengthObj.state = 0, measureLengthObj.result = 0 } function begainMeasureArea() { clickState = "areaMeasure"; for (var e = measureAreaGroup.children.length - 1; e >= 1; e--) measureAreaGroup.remove(measureAreaGroup.children[e]); measureAreaObj.points = [] } window.addEventListener("message", receiveMessage, !1); var drawMeasuredArea = function () { if (measureAreaObj.points.length > 0) { for (var e = [], a = 0; a < measureAreaObj.points.length; a++) e.push(measureAreaObj.points[a].x, .01, measureAreaObj.points[a].z); e.push(measureAreaObj.points[0].x, .01, measureAreaObj.points[0].z); var r = new THREE.BufferGeometry; r.addAttribute("position", new THREE.Float32BufferAttribute(e, 3)); var i = new THREE.LineBasicMaterial({ color: "blue", linewidth: 5 }), o = new THREE.Line(r, i); 1 == measureAreaGroup.children.length ? measureAreaGroup.add(o) : measureAreaGroup.children[1].geometry = r } }, drawBoundry = function (e) { if ("show" == e) { if (boundryGroup.visible = !0, 0 == boundryGroup.children.length) { for (var a = [], r = boundryData, i = 0; i < r.length; i += 2) { var o = r[i], n = r[i + 1]; a.push(MercatorGetXbyLongitude(o), 0, -MercatorGetYbyLatitude(n)) } var t, s, u; o = r[i = 0], n = r[i + 1]; a.push(MercatorGetXbyLongitude(o), 0, -MercatorGetYbyLatitude(n)), (t = new THREE.LineGeometry).setPositions(a), (s = new THREE.LineMaterial({ color: showAConfig.boundry.color, linewidth: showAConfig.boundry.width })).renderOrder = 9, s.depthTest = !1, (u = new THREE.Line2(t, s)).computeLineDistances(), u.renderOrder = 0, u.scale.set(1, 1, 1), u.renderOrder = 9, boundryGroup.add(u) } } else "hide" == e && (boundryGroup.visible = !1) }, drawPeibian = function (e) { if ("show" == e) if (peibianGroup.visible = !0, 0 == peibianGroup.children.length) for (var a = peibianData, r = new THREE.BoxBufferGeometry(.05, .05, .3), i = 0; i < a.length; i++) { var o = a[i].lon + .012846999999993614, n = a[i].lat + .006810000000001537 + 1e-4, t = (new THREE.Mesh(r, new THREE.MeshLambertMaterial({ color: 6736896, transparent: !0, opacity: .5 })), MercatorGetXbyLongitude(o)), s = MercatorGetYbyLatitude(n), u = (r = new THREE.RingGeometry(.4, .1, 12), new THREE.MeshBasicMaterial({ color: 6736896, side: THREE.DoubleSide, transparent: !0, opacity: .5 })); u.depthTest = !1; var l = new THREE.Mesh(r, u); a[i].name = a[i].detail, l.Tag = a[i], l.renderOrder = 98, l.position.set(t, 0, -s), l.rotateX(Math.PI / 2), peibianGroup.add(l) } else searchPeibian("BB"); else "hide" == e && (peibianGroup.visible = !1) }, searchPeibian = function (e) { for (var a = 0; a < peibianGroup.children.length; a++) peibianGroup.children[a].Tag.detail.search(e) >= 0 ? (peibianGroup.children[a].material.color.set(16776960), peibianGroup.children[a].material.opacity = .9) : (peibianGroup.children[a].material.color.set(6736896), peibianGroup.children[a].material.opacity = .5); if ("" == e) for (a = 0; a < peibianGroup.children.length; a++) peibianGroup.children[a].material.color.set(6736896), peibianGroup.children[a].material.opacity = .5 }, searchTongxin5G = function (e) { for (var a = 0; a < tongxin5GMapGroup.children.length; a++) tongxin5GMapGroup.children[a].Tag.detail.search(e) >= 0 ? (tongxin5GMapGroup.children[a].material.color.set(16776960), tongxin5GMapGroup.children[a].material.opacity = .9) : (tongxin5GMapGroup.children[a].material.color.set(16711935), tongxin5GMapGroup.children[a].material.opacity = .6); if ("" == e) for (a = 0; a < tongxin5GMapGroup.children.length; a++) tongxin5GMapGroup.children[a].material.color.set(16711935), tongxin5GMapGroup.children[a].material.opacity = .6 }, drawTongxin5G = function (e) { if ("show" == e) if (tongxin5GMapGroup.visible = !0, 0 == tongxin5GMapGroup.children.length) for (var a = peibianData, r = new THREE.ConeGeometry(.04, .2, 8), i = 0; i < a.length; i++) { var o = a[i].lon + .012846999999993614 + .001 * Math.cos(i), n = a[i].lat + .006810000000001537 + 1e-4 + .001 * Math.sin(i), t = MercatorGetXbyLongitude(o), s = MercatorGetYbyLatitude(n), u = (r = new THREE.RingGeometry(.8, .3, 3), new THREE.MeshBasicMaterial({ color: 16711935, side: THREE.DoubleSide, transparent: !0, opacity: .7 })); u.depthTest = !1; var l = new THREE.Mesh(r, u); a[i].name = a[i].detail, l.Tag = a[i], l.renderOrder = 98, l.position.set(t, 0, -s), l.rotateX(Math.PI / 2), l.rotateZ(Math.PI / 6), tongxin5GMapGroup.add(l) } else searchTongxin5G("BB"); else "hide" == e && (tongxin5GMapGroup.visible = !1) }, recordL = 0, updateScale = function () { var e = Math.sqrt((camera.position.x - controls.target.x) * (camera.position.x - controls.target.x) + (camera.position.y - controls.target.y) * (camera.position.y - controls.target.y) + (camera.position.z - controls.target.z) * (camera.position.z - controls.target.z)); if (Math.abs(recordL - e) >= .01) { if (recordL = e, raycaster.linePrecision = .02 * recordL, peibianGroup.visible && peibianGroup.children.length > 0) for (var a = 0; a < peibianGroup.children.length; a++) peibianGroup.children[a].scale.set(recordL / 50, recordL / 50, recordL / 50); if (tongxin5GMapGroup.visible && tongxin5GMapGroup.children.length > 0) for (a = 0; a < tongxin5GMapGroup.children.length; a++) tongxin5GMapGroup.children[a].scale.set(recordL / 50, recordL / 50, recordL / 50) } }, updatePlaneLineScale = function () { }, drawRegionBlock = function (e) { if ("show" == e) if (regionBlockGroup.visible = !0, 0 == regionBlockGroup.children.length) for (var a = regionBlock3.features, r = function (e, a) { for (var r = 16369.1554, i = 67202.5534, o = 20907.227, n = 62778.341, t = 112.540805, s = 37.906085, u = 112.592103, l = 37.866438, c = e.geometry.coordinates, d = [], g = 0; g < c.length; g++) { var p = c[g][0], h = c[g][1], m = (p = t + (c[g][0] - r) / (o - r) * (u - t), h = l + (c[g][1] - n) / (i - n) * (s - l), MercatorGetXbyLongitude(p)), b = MercatorGetYbyLatitude(h) + .3; d.push(new THREE.Vector2(m, b)) } var A = new THREE.Shape(d), G = new THREE.ExtrudeBufferGeometry(A, { depth: .3, bevelEnabled: !1 }), y = 6710784, L = ["R", "A", "B", "M", "W", "S", "U", "G"]; switch (L[a % 8]) { case "R": y = 6710784; break; case "A": y = 13395558; break; case "B": y = 10053324; break; case "M": y = 16724736; break; case "W": y = 10040166; break; case "S": y = 16724940; break; case "U": y = 10027008; break; case "G": y = 16711782 } var f = new THREE.MeshPhongMaterial({ color: y, wireframe: !1, transparent: !0, opacity: .8 }); f.depthTest = !1; var K = new THREE.Mesh(G, f); K.position.set(0, 0, 0), K.rotateX(-Math.PI / 2), K.scale.set(1, 1, 1), K.Tag = { regionType: ["居住用地", "公共管理与公共服务设施用地", "商业服务业设施用地", "工业用地", "物流仓储用地", "道路与交通设施用地", "公用设施用地", "绿地与广场用地"][a % 8], regionTypeSimple: L[a % 8], rongjilv: 99 }, K.renderOrder = 97, regionBlockGroup.add(K) }, i = 0; i < a.length; i++) r(a[i], i); else searchRegionBlock("BB"); else "hide" == e && (regionBlockGroup.visible = !1) }, drawSongdianquyu = function (e) { if ("show" == e) { if (songdianquGroup.visible = !0, 0 == songdianquGroup.children.length) { for (var a = songdianquyu.features, r = function (e, a) { for (var r = 16369.1554, i = 67202.5534, o = 20907.227, n = 62778.341, t = 112.540805, s = 37.906085, u = 112.592103, l = 37.866438, c = e.geometry.coordinates, d = [], g = 0; g < c.length; g++) { var p = c[g][0], h = c[g][1], m = (p = t + (c[g][0] - r) / (o - r) * (u - t), h = l + (c[g][1] - n) / (i - n) * (s - l), MercatorGetXbyLongitude(p)), b = MercatorGetYbyLatitude(h) + .3; d.push(new THREE.Vector2(m, b)) } var A = new THREE.Shape(d), G = { depth: .01 * a * .4, bevelEnabled: !1 }, y = new THREE.ExtrudeBufferGeometry(A, G), L = 6710784, f = ["R", "A", "B", "M", "W", "S", "U", "G"]; switch (f[a % 8]) { case "R": L = 6710784; break; case "A": L = 13395558; break; case "B": L = 10053324; break; case "M": L = 16724736; break; case "W": L = 10040166; break; case "S": L = 16724940; break; case "U": L = 10027008; break; case "G": L = 16711782 } var K = new THREE.MeshPhongMaterial({ color: L, wireframe: !1, transparent: !0, opacity: .8 }); K.depthTest = !1; var E = new THREE.Mesh(y, K); E.position.set(0, 0, 0), E.rotateX(-Math.PI / 2), E.scale.set(1, 1, 1), E.Tag = { regionType: ["居住用地", "公共管理与公共服务设施用地", "商业服务业设施用地", "工业用地", "物流仓储用地", "道路与交通设施用地", "公用设施用地", "绿地与广场用地"][a % 8], regionTypeSimple: f[a % 8], rongjilv: 99 }, E.renderOrder = 97, songdianquGroup.add(E) }, i = 0; i < a.length; i++) r(a[i], i); songdianquGroup.position.set(-25.32999999999998, 0, 11.699999999999987) } } else "hide" == e && (songdianquGroup.visible = !1) }, searchRegionBlock = function (e) { for (var a = 0; a < regionBlockGroup.children.length; a++) if (regionBlockGroup.children[a].Tag.regionType.search(e) >= 0) regionBlockGroup.children[a].material.color.set(16776960), regionBlockGroup.children[a].material.opacity = .9; else { var r = 6710784; switch (regionBlockGroup.children[a].Tag.regionTypeSimple) { case "R": r = 6710784; break; case "A": r = 13395558; break; case "B": r = 10053324; break; case "M": r = 16724736; break; case "W": r = 10040166; break; case "S": r = 16724940; break; case "U": r = 10027008; break; case "G": r = 16711782 } regionBlockGroup.children[a].material.color.set(r), regionBlockGroup.children[a].material.opacity = .7 } }, dataOfLineLabel = [], lineShowIndex = [0, 1, 2, 3, 4, 5, 6], chaoliuData = { geometry: null, vertices: [] }, drawLine = function (e) { var a = !1; if ("show" == e) { var r = { x: 17545.309, y: 65811.8395 }, i = { x: 20904.8089, y: 62787.9504 }, o = { x: 112.553929, y: 37.894187 }, n = { x: 112.592161, y: 37.866492 }; if (lineGroup.visible = !0, chaoliuData.geometry = new THREE.BufferGeometry, 0 == lineGroup.children.length) { for (var t = shudianxian3, s = 0; s < t.features.length; s++) if ("LineString" == t.features[s].geometry.type) { var u = t.features[s].properties.Layer, l = new THREE.BufferGeometry, c = [], d = new THREE.LineGeometry, g = t.features[s].geometry.coordinates, p = "orange", h = (t.features[s].properties.EntityHandle, getNameAndColorOfLine(u)); p = h[0]; var m = h[1], b = 3 == h.length ? h[2] : "未知"; if (3 != h.length || "方案" != h[2]) if (a && (p = "orange"), p = getColorByStation(b), getShowByStation(b)) { for (var A = getIndexByStation(b), G = [], y = 0; y < g.length; y++) { var L = o.x + (g[y][0] - r.x) / (i.x - r.x) * (n.x - o.x), f = n.y + (g[y][1] - i.y) / (r.y - i.y) * (o.y - n.y), K = MercatorGetXbyLongitude(L), E = MercatorGetYbyLatitude(f); if (c.push(K, 0, 0 - E), y > 0) { var M = o.x + (g[y - 1][0] - r.x) / (i.x - r.x) * (n.x - o.x), x = n.y + (g[y - 1][1] - i.y) / (r.y - i.y) * (o.y - n.y), w = MercatorGetXbyLongitude(M), v = MercatorGetYbyLatitude(x); G.push(), G.push(), dataOfLineLabel.push({ x: (K + w) / 2, z: -(E + v) / 2, nameV: m, colorR: p, indexV: A }); var T = Math.sqrt((K - w) * (K - w) + (E - v) * (E - v)); if (T > .5) (function (e, a, r, i, o) { for (var n = 0; n < e; n++) for (var t = 0; t < chaoliufenxiGroupCount; t++) chaoliuFenxiData[t].push((chaoliufenxiGroupCount * n + t) / (chaoliufenxiGroupCount * e) * (i - a) + a), chaoliuFenxiData[t].push((chaoliufenxiGroupCount * n + t) / (chaoliufenxiGroupCount * e) * (o - r) + r) })(Math.ceil(T / .5), w, v, K, E); else (function (e, a, r, i, o) { for (var n = 0; n < e; n++) for (var t = 0; t < chaoliufenxiGroupCount; t++) chaoliuFenxiData[t].push((chaoliufenxiGroupCount * n + t) / (chaoliufenxiGroupCount * e) * (i - a) + a), chaoliuFenxiData[t].push((chaoliufenxiGroupCount * n + t) / (chaoliufenxiGroupCount * e) * (o - r) + r) })(1, w, v, K, E) } } l.addAttribute("position", new THREE.Float32BufferAttribute(c, 3)), d.setPositions(c); var C, O = new THREE.LineBasicMaterial({ color: p, linewidth: 1, transparent: !0, opacity: 0 }); (C = new THREE.LineMaterial({ color: p, linewidth: .003 })).depthTest = !1; var j, R = new THREE.Line(l, O); if (R.Tag = { name: m, station: b }, (j = new THREE.Line2(d, C)).computeLineDistances(), j.Tag = { name: m, voltage: "", indexV: A, colorR: p }, j.renderOrder = 99, j.scale.set(1, 1, 1), lineGroup.add(R), lineGroup.add(j), "" == m) { if (!a) { var H = "case '" + u + "':\r{\r{ return ['green', '', ''] };}; break;"; console.log("EntityHandle", H) } a = !0 } } } } else lineGroup.visible = !0 } else "hide" == e && (lineGroup.visible = !1); updateLabelOfLine() }, drawChaoliufenxi = function (e) { if ("show" == e) animateChaoliuFenxi = function () { for (var e = Date.now() % 900, a = 0; a < chaoliuFenxiData.length; a++) e < 900 / chaoliuFenxiData.length * a && e > 900 / chaoliuFenxiData.length * (a - 1) ? chaoliufenxiGroup[a].visible = !0 : chaoliufenxiGroup[a].visible = !1 }; else if ("hide" == e) { for (var a = 0; a < chaoliuFenxiData.length; a++) chaoliufenxiGroup[a].visible = !1; animateChaoliuFenxi = function () { } } var r = function (e, a) { for (var r = new THREE.BufferGeometry, i = e.length / 2, o = new Float32Array(3 * i), n = new Float32Array(3 * i), t = 0; t < i; t++) o[3 * t] = e[2 * t + 0], o[3 * t + 1] = .04, o[3 * t + 2] = -e[2 * t + 1], n[3 * t] = 0, n[3 * t + 1] = 0, n[3 * t + 2] = 255; r.addAttribute("position", new THREE.BufferAttribute(o, 3)), r.addAttribute("color", new THREE.BufferAttribute(n, 3)), r.computeBoundingBox(); var s = new THREE.PointsMaterial({ size: .08, vertexColors: THREE.VertexColors }), u = new THREE.Points(r, s); a.add(u) }; for (a = 0; a < chaoliuFenxiData.length; a++) r(chaoliuFenxiData[a], chaoliufenxiGroup[a]) }, animateChaoliuFenxi = function () { for (var e = Date.now() % 900, a = 0; a < chaoliuFenxiData.length; a++) e < 900 / chaoliuFenxiData.length * a && e > 900 / chaoliuFenxiData.length * (a - 1) ? chaoliufenxiGroup[a].visible = !0 : chaoliufenxiGroup[a].visible = !1 }, searchLineByIndex = function (e) { if (lineShowIndex = e, lineGroup.visible) for (var a = 0; a < lineGroup.children.length; a++) "Line2" == lineGroup.children[a].type && (e.indexOf(lineGroup.children[a].Tag.indexV) >= 0 ? lineGroup.children[a].visible = !0 : lineGroup.children[a].visible = !1); updateLabelOfLine() }, searchLineByName = function (e) { if (lineGroup.visible) { for (var a = 0; a < lineGroup.children.length; a++) "Line2" == lineGroup.children[a].type && (lineGroup.children[a].Tag.name.search(e) >= 0 ? (lineGroup.children[a].material.color.set(16776960), lineGroup.children[a].material.opacity = .6, lineGroup.children[a].material.transparent = !0) : (lineGroup.children[a].material.color.set(lineGroup.children[a].Tag.colorR), lineGroup.children[a].material.transparent = !1)); if ("" == e) for (a = 0; a < lineGroup.children.length; a++) "Line2" == lineGroup.children[a].type && (lineGroup.children[a].material.color.set(lineGroup.children[a].Tag.colorR), lineGroup.children[a].material.transparent = !1) } }, guanGouObj = { matLineDashed: new THREE.LineDashedMaterial({ vertexColors: THREE.VertexColors, scale: 2, dashSize: 1, gapSize: 1 }), matLine: new THREE.LineMaterial({ color: "orange", linewidth: .01, vertexColors: THREE.VertexColors, dashed: !1 }) }, drawLine2 = function (e) { if ("show" == e) { var a = { x: 17545.309, y: 65811.8395 }, r = { x: 20904.8089, y: 62787.9504 }, i = { x: 112.553929, y: 37.894187 }, o = { x: 112.592161, y: 37.866492 }; if (guangouGroup.visible = !0, 0 == guangouGroup.children.length) { for (var n = guangouData, t = 0; t < n.features.length; t++) if ("LineString" == n.features[t].geometry.type) { var s = n.features[t].properties.Layer, u = [], l = new THREE.LineGeometry, c = n.features[t].geometry.coordinates, d = "blue"; "a01" == s && (d = "skyblue"); for (var g = 0; g < c.length; g++) { var p = i.x + (c[g][0] - a.x) / (r.x - a.x) * (o.x - i.x), h = o.y + (c[g][1] - r.y) / (a.y - r.y) * (i.y - o.y), m = MercatorGetXbyLongitude(p), b = MercatorGetYbyLatitude(h); u.push(m, 0, 0 - b) } l.setPositions(u); var A = new THREE.LineMaterial({ color: d, linewidth: .003 }); A.depthTest = !1; var G = new THREE.Line2(l, A); G.computeLineDistances(), G.Tag = { name: "", voltage: "", indexV: "", colorR: d }, G.renderOrder = 99, G.scale.set(1, 1, 1), guangouGroup.add(G) } } else guangouGroup.visible = !0 } else "hide" == e && (guangouGroup.visible = !1) }, drawBiandiansuo = function (e) { if ("show" == e) if (biandiansuoGroup.visible = !0, 0 == biandiansuoGroup.children.length) for (var a = { x: 17545.309, y: 65811.8395 }, r = { x: 20904.8089, y: 62787.9504 }, i = { x: 112.553929, y: 37.894187 }, o = { x: 112.592161, y: 37.866492 }, n = biandiansuo2, t = 0; t < n.length; t++) { var s = document.createElement("div"), u = document.createElement("img"); u.src = "Pic/biandianzhan110kv.png", s.appendChild(u), s.className = "biandianzhanTuPian"; var l = "0xffff00"; switch (n[t].name) { case "东大变": l = "red"; break; case "杏花岭变": l = "purple"; break; case "柳溪变电站": l = "orange"; break; case "城西站": l = "purple"; break; case "铜锣湾变": case "城北站": l = "orange"; break; case "解放变": l = "purple" } switch (l = getColorByStation(n[t].name), n[t].v) { case "110kv": var c = i.x + (n[t].position[0] - a.x) / (r.x - a.x) * (o.x - i.x), d = o.y + (n[t].position[1] - r.y) / (a.y - r.y) * (i.y - o.y), g = MercatorGetXbyLongitude(c), p = MercatorGetYbyLatitude(d), h = showAConfig.biandianzhan.l110kv.radius, m = l, b = new THREE.RingGeometry(h, .75 * h, 18); (y = new THREE.MeshBasicMaterial({ color: m, side: THREE.DoubleSide })).depthTest = !1; var A = new THREE.Mesh(b, y), G = { x: g, y: 0, z: -p }; A.Tag = { name: n[t].name, position: G }, A.renderOrder = 98, A.position.set(g, 0, -p), A.rotateX(Math.PI / 2), biandiansuoGroup.add(A), (K = document.createElement("div")).className = "labelbiandianzhan", K.textContent = n[t].name, K.style.marginTop = "-1em", K.style.color = Number.isInteger(l) ? get16(l) : l, (E = new THREE.CSS2DObject(K)).position.set(g, 0, -p), E.positionTag = [g, 0, -p], biandiansuoGroup.add(E); break; case "220kv": h = showAConfig.biandianzhan.l220kv.radius, m = l, c = i.x + (n[t].position[0] - a.x) / (r.x - a.x) * (o.x - i.x), d = o.y + (n[t].position[1] - r.y) / (a.y - r.y) * (i.y - o.y), g = MercatorGetXbyLongitude(c), p = MercatorGetYbyLatitude(d); var y, L = new THREE.RingGeometry(h, .75 * h, 18); (y = new THREE.MeshBasicMaterial({ color: m, side: THREE.DoubleSide })).depthTest = !1; var f = new THREE.Mesh(L, y); f.name = n[t].name; G = { x: g, y: 0, z: -p }; f.Tag = { name: n[t].name, position: G }, f.renderOrder = 98, f.position.set(g, 0, -p), f.rotateX(Math.PI / 2), biandiansuoGroup.add(f); var K, E, M = new THREE.RingGeometry(.5 * h, .25 * h, 18), x = new THREE.Mesh(M, y); x.Tag = { name: n[t].name, position: G }, x.renderOrder = 98, x.position.set(g, 0, -p), x.rotateX(Math.PI / 2), biandiansuoGroup.add(x), (K = document.createElement("div")).className = "labelbiandianzhan", K.textContent = n[t].name, K.style.marginTop = "-1em", K.style.color = Number.isInteger(l) ? get16(l) : l, (E = new THREE.CSS2DObject(K)).position.set(g, 0, -p), E.positionTag = [g, 0, -p], biandiansuoGroup.add(E) } } else { searchBiandiansuo("BB"); for (t = 0; t < biandiansuoGroup.children.length; t++) biandiansuoGroup.children[t].positionTag && biandiansuoGroup.children[t].position.set(biandiansuoGroup.children[t].positionTag[0], biandiansuoGroup.children[t].positionTag[1], biandiansuoGroup.children[t].positionTag[2]) } else if ("hide" == e) { biandiansuoGroup.visible = !1; for (t = 0; t < biandiansuoGroup.children.length; t++) biandiansuoGroup.children[t].positionTag && biandiansuoGroup.children[t].position.set(0, 0, 0) } }, searchBiandiansuo = function (e) { for (var a = 0; a < biandiansuoGroup.children.length; a++) "Mesh" == biandiansuoGroup.children[a].type && biandiansuoGroup.children[a].Tag.name == e && controls.target.set(biandiansuoGroup.children[a].Tag.position.x, biandiansuoGroup.children[a].Tag.position.y, biandiansuoGroup.children[a].Tag.position.z) }, drawBuildings = function (e) { if ("show" == e) { if (buildingsGroups.visible = !0, 0 == buildingsGroups.children.length) { var a = new THREE.LoadingManager; new THREE.MTLLoader(a).setPath("ObjTag/shenggongsi/").load("build1.mtl", function (e) { e.preload(), new THREE.OBJLoader(a).setMaterials(e).setPath("ObjTag/shenggongsi/").load("build1.obj", function (e) { for (var a = 0; a < e.children.length; a++) if (e.children[a].isMesh) for (var r = 0; r < e.children[a].material.length; r++) e.children[a].material[r].side = THREE.DoubleSide; e.position.y = 0, scene.add(e), e.rotateX(-Math.PI / 2), e.rotateZ(-.07); var i = { x: MercatorGetXbyLongitude(112.5782425), y: 0, z: -MercatorGetYbyLatitude(37.87923660278321) }; e.position.set(MercatorGetXbyLongitude(112.5782425), 0, -MercatorGetYbyLatitude(37.87923660278321)), e.scale.set(.015, .015, .015), e.castShadow = !0, e.receiveShadow = !0, e.name = "build1", e.Tag = { name: "省公司", position: i }, e.rotateX(Math.PI / 2), buildingsGroups.add(e) }, function () { }, function () { }) }), new THREE.MTLLoader(a).setPath("ObjTag/shimao/").load("build2.mtl", function (e) { e.preload(), new THREE.OBJLoader(a).setMaterials(e).setPath("ObjTag/shimao/").load("build2.obj", function (e) { for (var a = 0; a < e.children.length; a++) if (e.children[a].isMesh) for (var r = 0; r < e.children[a].material.length; r++) e.children[a].material[r].side = THREE.DoubleSide; e.position.y = 0, scene.add(e), e.rotateX(-Math.PI / 2), e.rotateZ(-.03); var i = { x: MercatorGetXbyLongitude(112.56329469612449), y: 0, z: -MercatorGetYbyLatitude(37.88009395599366) }; e.position.set(MercatorGetXbyLongitude(112.56329469612449), 0, -MercatorGetYbyLatitude(37.88009395599366)), e.scale.set(.095, .095, .095), e.castShadow = !0, e.receiveShadow = !0, e.name = "build2", e.Tag = { name: "世贸", position: i }, e.rotateX(Math.PI / 2), buildingsGroups.add(e) }, function () { }, function () { }) }), new THREE.MTLLoader(a).setPath("ObjTag/build4/").load("build4fujia.mtl", function (e) { e.preload(), new THREE.OBJLoader(a).setMaterials(e).setPath("ObjTag/build4/").load("build4fujia.obj", function (e) { for (var a = 0; a < e.children.length; a++) if (e.children[a].isMesh) for (var r = 0; r < e.children[a].material.length; r++) e.children[a].material[r].side = THREE.DoubleSide; e.position.y = 0, scene.add(e), e.rotateX(-Math.PI / 2), e.rotateZ(-.03); var i = { x: MercatorGetXbyLongitude(112.5574), y: 0, z: -MercatorGetYbyLatitude(37.8927) }; e.position.set(MercatorGetXbyLongitude(112.5574), 0, -MercatorGetYbyLatitude(37.8927)), e.scale.set(.02, .035, .025), e.castShadow = !0, e.receiveShadow = !0, e.name = "mj1", e.Tag = { name: "民居1", position: i }, e.rotateX(Math.PI / 2), buildingsGroups.add(e); var o = e.clone(); i = { x: MercatorGetXbyLongitude(112.5574), y: 0, z: -MercatorGetYbyLatitude(37.8917) }; o.name = "mj2", o.Tag = { name: "民居2", position: i }, o.position.set(MercatorGetXbyLongitude(112.5574), 0, -MercatorGetYbyLatitude(37.8917)), buildingsGroups.add(o); var n = e.clone(); i = { x: MercatorGetXbyLongitude(112.5575), y: 0, z: -MercatorGetYbyLatitude(37.8907) }; n.name = "mj3", n.Tag = { name: "民居3", position: i }, n.position.set(MercatorGetXbyLongitude(112.5575), 0, -MercatorGetYbyLatitude(37.8907)), buildingsGroups.add(n); var t = e.clone(); i = { x: MercatorGetXbyLongitude(112.5575), y: 0, z: -MercatorGetYbyLatitude(37.8897) }; t.name = "mj4", n.Tag = { name: "民居4", position: i }, t.position.set(MercatorGetXbyLongitude(112.5575), 0, -MercatorGetYbyLatitude(37.8897)), buildingsGroups.add(t); var s = e.clone(); i = { x: MercatorGetXbyLongitude(112.5575), y: 0, z: -MercatorGetYbyLatitude(37.8875) }; s.name = "mj5", s.position.set(MercatorGetXbyLongitude(112.5575), 0, -MercatorGetYbyLatitude(37.8875)), buildingsGroups.add(s); var u = e.clone(); u.position.set(MercatorGetXbyLongitude(112.5575), 0, -MercatorGetYbyLatitude(37.8868)), buildingsGroups.add(u); var l = e.clone(); l.position.set(MercatorGetXbyLongitude(112.5576), 0, -MercatorGetYbyLatitude(37.88601)), buildingsGroups.add(l); var c = e.clone(); c.position.set(MercatorGetXbyLongitude(112.5576), 0, -MercatorGetYbyLatitude(37.88521)), buildingsGroups.add(c) }, function () { }, function () { }) }), new THREE.MTLLoader(a).setPath("ObjTag/wandaxiugai/").load("wandagcxiugai.mtl", function (e) { e.preload(), new THREE.OBJLoader(a).setMaterials(e).setPath("ObjTag/wandaxiugai/").load("wandagcxiugai.obj", function (e) { for (var a = 0; a < e.children.length; a++) if (e.children[a].isMesh) for (var r = 0; r < e.children[a].material.length; r++) e.children[a].material[r].side = THREE.DoubleSide; e.position.y = 0, scene.add(e), e.rotateX(-Math.PI / 2), e.rotateZ(Math.PI / 2); var i = { x: MercatorGetXbyLongitude(112.56774847960612), y: .001, z: -MercatorGetYbyLatitude(37.88849601745606) }; e.position.set(MercatorGetXbyLongitude(112.56774847960612), .001, -MercatorGetYbyLatitude(37.88849601745606)), e.scale.set(.09, .09, .09), e.castShadow = !0, e.receiveShadow = !0, e.name = "wd", e.Tag = { name: "万达广场", position: i }, e.rotateX(Math.PI / 2), buildingsGroups.add(e) }, function () { }, function () { }) }); new THREE.STLLoader; 0 } } else "hide" == e && (buildingsGroups.visible = !1) }, searchBuildings = function (e) { for (var a = 0; a < buildingsGroups.children.length; a++) buildingsGroups.children[a].Tag.name == e && controls.target.set(buildingsGroups.children[a].Tag.position.x, buildingsGroups.children[a].Tag.position.y, buildingsGroups.children[a].Tag.position.z) }, setupCanvasDrawing = function () { mapTexture = new THREE.CanvasTexture(ctx.canvas), mapTexture.needsUpdate = !0, mapGroup.children[0].material.map = mapTexture }, get16 = function (e) { for (var a = "", r = 0; r < 6; r++) { switch (e % 16) { case 0: a = "0" + a; break; case 1: a = "1" + a; break; case 2: a = "2" + a; break; case 3: a = "3" + a; break; case 4: a = "4" + a; break; case 5: a = "5" + a; break; case 6: a = "6" + a; break; case 7: a = "7" + a; break; case 8: a = "8" + a; break; case 9: a = "9" + a; break; case 10: a = "a" + a; break; case 11: a = "b" + a; break; case 12: a = "c" + a; break; case 13: a = "d" + a; break; case 14: a = "e" + a; break; case 15: a = "f" + a } e >>= 4 } return a = "#" + a }, visibleOfLabelOfLine = !1, showLabelOfLine = function () { for (var e = 0; e < dataOfLineLabel.length; e++) { var a = dataOfLineLabel[e].x, r = dataOfLineLabel[e].z, i = document.createElement("div"); i.className = "labelline", i.textContent = dataOfLineLabel[e].nameV, i.style.marginTop = "-1em"; var o = dataOfLineLabel[e].colorR; i.style.color = Number.isInteger(o) ? get16(o) : o; var n = new THREE.CSS2DObject(i); n.position.set(a, 0, r), n.positionTag = [a, 0, r], lineLabelGroup.add(n) } }, clearLabelOfLine = function () { for (var e = lineLabelGroup.children.length - 1; e >= 0; e--) lineLabelGroup.remove(lineLabelGroup.children[e]) }, updateLabelOfLine = function () { if (0 == arguments.length) { if (dataOfLineLabel.length > 0) if (lineGroup.visible) { var e = (mercatoCenter.x - 7) * Math.pow(2, 19 - mercatoCenter.zoom), a = (mercatoCenter.x + 7) * Math.pow(2, 19 - mercatoCenter.zoom), r = (mercatoCenter.zValue - 7) * Math.pow(2, 19 - mercatoCenter.zoom), i = (mercatoCenter.zValue + 7) * Math.pow(2, 19 - mercatoCenter.zoom); clearLabelOfLine(); for (var o = 0; o < dataOfLineLabel.length; o++) { var n = dataOfLineLabel[o].x, t = dataOfLineLabel[o].z, s = (n >> 19 - mercatoCenter.zoom + 1) + "_" + (t >> 19 - mercatoCenter.zoom + 1) + "_" + chineseToNumStr(dataOfLineLabel[o].nameV); if (n >= e && n <= a && t >= r && t <= i && lineShowIndex.indexOf(dataOfLineLabel[o].indexV) >= 0) if (lineLabelGroup.getObjectByName(s)); else { var u = getXianShunByName(dataOfLineLabel[o].nameV); if (u >= 50) { (c = document.createElement("div")).className = "labelline", c.textContent = dataOfLineLabel[o].nameV + "(线损" + u / 10 + "%)", c.style.marginTop = "-1em"; var l = dataOfLineLabel[o].colorR; c.style.borderColor = "red", c.style.color = "red", (d = new THREE.CSS2DObject(c)).position.set(n, 0, t), d.positionTag = [n, 0, t], d.name = s, lineLabelGroup.add(d) } else { var c; (c = document.createElement("div")).className = "labelline", c.textContent = dataOfLineLabel[o].nameV, c.style.marginTop = "-1em"; var d; l = dataOfLineLabel[o].colorR; c.style.borderColor = Number.isInteger(l) ? get16(l) : l, (d = new THREE.CSS2DObject(c)).position.set(n, 0, t), d.positionTag = [n, 0, t], d.name = s, lineLabelGroup.add(d) } } } } else clearLabelOfLine() } else 1 == arguments.length && console.log("a", arguments[0]) }, chineseToNumStr = function (e) { for (var a = "", r = 0; r < e.length; r++) "" == a ? a = e.charCodeAt(r).toString(16) : a += "_" + e.charCodeAt(r).toString(16); return a };